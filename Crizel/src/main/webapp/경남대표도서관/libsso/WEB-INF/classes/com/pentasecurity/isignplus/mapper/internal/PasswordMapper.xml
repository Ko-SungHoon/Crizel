<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pentasecurity.isignplus.password.internal.PasswordMapper">
    
    <select id="findPolicyPasswordBySid" resultType="com.pentasecurity.isignplus.password.model.PasswordHistoryVO" parameterType="long">
        SELECT 
            SID as sid, 
            LASTCHANGEDATE as lastChangeDate, 
            INCORRECTTIME as incorrectTime, 
            ISDEFAULTPWD as isDefaultPwd, 
            INCORRECTNUM as incorrectNum,
            LASTCHANGEPW as lastChangePw
        FROM 
            isign_pwdhistory 
        WHERE
            SID = #{sid}
    </select>
    
    <select id="findPolicyPasswordById" resultType="com.pentasecurity.isignplus.password.model.PasswordHistoryVO" parameterType="String">
        SELECT 
            p.SID as sid, 
            LASTCHANGEDATE as lastChangeDate, 
            INCORRECTTIME as incorrectTime, 
            ISDEFAULTPWD as isDefaultPwd, 
            INCORRECTNUM as incorrectNum,
            LASTCHANGEPW as lastChangePw
        FROM 
            isign_pwdhistory p,
            isign_user u
        WHERE
            p.SID = u.SID
        AND
            u.ID = #{id}
    </select>
    
    <select id="updateIncorrectNumAndDate" parameterType="com.pentasecurity.isignplus.password.model.PasswordHistoryVO">
        UPDATE 
            isign_pwdhistory
        SET
            INCORRECTTIME = now(),
            INCORRECTNUM = #{incorrectNum}
        WHERE
            SID = #{sid}
    </select>
    
    <select id="updatePassword" parameterType="long">
        UPDATE 
            isign_pwdhistory
        SET
            LASTCHANGEDATE = now(),
            ISDEFAULTPWD = 0,
            LASTCHANGEPW = ''
        WHERE
            SID = #{sid}
    </select>
    
    <insert id="insertPasswordHistoryForExternalDb" parameterType="long">
        INSERT INTO ISIGN_PWDHISTORY 
            ( SID, LASTCHANGEDATE, ISDEFAULTPWD, INCORRECTNUM, LASTCHANGEPW) 
        VALUES 
            ( #{sid}, now(), 0, 0, '')
    </insert>

    <insert id="insertPasswordHistory" parameterType="long">
        INSERT INTO ISIGN_PWDHISTORY
        ( SID, LASTCHANGEDATE, ISDEFAULTPWD, INCORRECTNUM, LASTCHANGEPW)
        VALUES
        ( #{sid}, now(), 0, 0, '')
        ON DUPLICATE KEY
        UPDATE
        INCORRECTNUM = 0
    </insert>

    <update id="updateLastChangePasswordForExternalDb" parameterType="com.pentasecurity.isignplus.password.model.PasswordHistoryVO">
        UPDATE
            isign_pwdhistory
        SET
            LASTCHANGEPW = #{lastChangePw}
        WHERE
            SID = #{sid}
    </update>
    
    <select id="findPrevPasswordHistory" parameterType="long" resultType="String">
        SELECT password FROM isign_previous_password_history WHERE sid = #{sid} ORDER BY savedate DESC
    </select>
    
    <delete id="deletePrevPasswordHistory" parameterType="hashMap">
        DELETE FROM isign_previous_password_history WHERE sid = #{sid} ORDER BY savedate ASC LIMIT #{deleteCount};
    </delete>
    
    <insert id="insertPrevPasswordHistory" parameterType="hashMap">
        INSERT INTO isign_previous_password_history 
            (sid, password, savedate)
        VALUES
            (#{sid}, #{password}, now(3))
    </insert>
    
    <select id="findPasswordQABySid" resultType="com.pentasecurity.isignplus.password.model.PasswordQAVO" parameterType="long">
        SELECT 
            sid as sid, 
            question as question, 
            answer as answer
        FROM 
            isign_password_question_answer 
        WHERE
            SID = #{sid}
    </select>
    
    <update id="savePasswordQA" parameterType="com.pentasecurity.isignplus.password.model.PasswordQAVO">
		INSERT INTO isign_password_question_answer (
			sid,
			question,
			answer
		) VALUES (
			#{sid},
			#{question},
			#{answer}
		)
		ON DUPLICATE KEY
		UPDATE
			question = #{question},
			answer = #{answer}
	</update>
</mapper>