<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>ISign+</title>
        
        <style>
            h1 {
                text-align: center;
            }
                    
            div {
                display:block;            
                margin: 0 auto;
                width:800px;
            }
                
            img, form {
                margin-left: 20px;
            }                                
        </style>    
        
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
         <script th:src="@{/resources/js/authentication/fido1/u2f-api.js}"></script>
         <script th:inline="javascript">
            var registeredKeys = JSON.parse([[${responseResult.message}]]);
            var appId = registeredKeys[0].appId;
            var challenge = registeredKeys[0].challenge;
            var sessionId = registeredKeys[0].sessionId;
                
            // 토큰 정보등을 가지고 returnUrl로 forward
            function sendToken(resultCode, resultMessage, secureToken, secureSessionId, returnUrl) {
                
                var form = $('<form action="' + returnUrl + '" method="post">' +
                  '<input type="text" name="resultCode" value="' + resultCode + '" />' +
                  '<input type="text" name="resultMessage" value="' + resultMessage + '" />' +
                  '<input type="text" name="secureToken" value="' + secureToken + '" />' +
                  '<input type="text" name="secureSessionId" value="' + secureSessionId + '" />' +
                  '</form>');
                
                $('body').append(form);
                form.submit();
            }
            
            u2f.sign(appId, challenge, registeredKeys, function(result) {
                if (result.errorCode) {
                    /*
                    interface ErrorCode {
                        const short OK = 0;
                        const short OTHER_ERROR = 1;
                        const short BAD_REQUEST = 2;
                        const short CONFIGURATION_UNSUPPORTED = 3;
                        const short DEVICE_INELIGIBLE = 4;
                        const short TIMEOUT = 5;
                    };                        
                    */                    
                    alert("Failed. Error code: " + result.errorCode);
                    return;
                  }
              
                $.post("/authentication/fido1/u2f/authenticate", {clientData:result.clientData, signatureData:result.signatureData,
                    sessionId:sessionId})
                    .done(function(responseResult, status){
                        if (status == 'success' && responseResult.resultCode == '000000') {                        
                                //alert("인증이 완료되었습니다.");
                                // 토큰 값을 returnURL로 보내주기
                                sendToken(responseResult.resultCode, 
                                        responseResult.resultMessage, 
                                        responseResult.secureToken, 
                                        responseResult.secureSessionId, 
                                        responseResult.returnUrl);                                
                        } else {
                            alert(responseResult.resultMessage);
                        }
                    })
                    .fail(function() {
                        alert("error");    
                    })                    
                }, 1000
            )         
         </script>        
    </head>
    <body>
        <div id="header">
            <h1>ISign+ FIDO U2F Authentication</h1>
            <hr />
        </div>
        
        <div id="content">
            <ul>    
                <li>인증 절차를 위해 인증 장치 버튼을 클릭 혹은 터치하여 주시기 바랍니다.</li>
            </ul>
            <hr />
        </div>
        
         <div id="footer">
             <p>ⓒ2017 Penta Security Systems Inc. All rights reserved.</p>
         </div>                 
    </body>
</html>