/**
 * Javascript implementation of PKCS#7 v1.5.
 *
 * @author Stefan Siegl
 * @author Dave Longley
 *
 * Copyright (c) 2012 Stefan Siegl <stesie@brokenpipe.de>
 * Copyright (c) 2012-2015 Digital Bazaar, Inc.
 *
 * Currently this implementation only supports ContentType of EnvelopedData,
 * EncryptedData, or SignedData at the root level. The top level elements may
 * contain only a ContentInfo of ContentType Data, i.e. plain data. Further
 * nesting is not (yet) supported.
 *
 * The Forge validators for PKCS #7's ASN.1 structures are available from
 * a separate file pkcs7asn1.js, since those are referenced from other
 * PKCS standards like PKCS #12.
 */
!function(){function e(e){function t(t){var r={},n=[];if(!u.validate(t,l.asn1.recipientInfoValidator,r,n)){var a=new Error("Cannot read PKCS#7 RecipientInfo. ASN.1 object is not an PKCS#7 RecipientInfo.");throw a.errors=n,a}return{version:r.version.charCodeAt(0),issuer:e.pki.RDNAttributesAsArray(r.issuer),serialNumber:e.util.createBuffer(r.serial).toHex(),encryptedContent:{algorithm:u.derToOid(r.encAlgorithm),parameter:r.encParameter.value,content:r.encKey}}}function r(t){return u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[u.create(u.Class.UNIVERSAL,u.Type.INTEGER,!1,u.integerToDer(t.version).getBytes()),u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[e.pki.distinguishedNameToAsn1({attributes:t.issuer}),u.create(u.Class.UNIVERSAL,u.Type.INTEGER,!1,e.util.hexToBytes(t.serialNumber))]),u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[u.create(u.Class.UNIVERSAL,u.Type.OID,!1,u.oidToDer(t.encryptedContent.algorithm).getBytes()),u.create(u.Class.UNIVERSAL,u.Type.NULL,!1,"")]),u.create(u.Class.UNIVERSAL,u.Type.OCTETSTRING,!1,t.encryptedContent.content)])}function n(e){for(var r=[],n=0;n<e.length;++n)r.push(t(e[n]));return r}function a(e){for(var t=[],n=0;n<e.length;++n)t.push(r(e[n]));return t}function i(t){var r=u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[u.create(u.Class.UNIVERSAL,u.Type.INTEGER,!1,u.integerToDer(t.version).getBytes()),u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[e.pki.distinguishedNameToAsn1({attributes:t.issuer}),u.create(u.Class.UNIVERSAL,u.Type.INTEGER,!1,e.util.hexToBytes(t.serialNumber))]),u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[u.create(u.Class.UNIVERSAL,u.Type.OID,!1,u.oidToDer(t.digestAlgorithm).getBytes()),u.create(u.Class.UNIVERSAL,u.Type.NULL,!1,"")])]);if(t.authenticatedAttributesAsn1&&r.value.push(t.authenticatedAttributesAsn1),r.value.push(u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[u.create(u.Class.UNIVERSAL,u.Type.OID,!1,u.oidToDer(t.signatureAlgorithm).getBytes()),u.create(u.Class.UNIVERSAL,u.Type.NULL,!1,"")])),r.value.push(u.create(u.Class.UNIVERSAL,u.Type.OCTETSTRING,!1,t.signature)),t.unauthenticatedAttributes.length>0){for(var n=u.create(u.Class.CONTEXT_SPECIFIC,1,!0,[]),a=0;a<t.unauthenticatedAttributes.length;++a){var i=t.unauthenticatedAttributes[a];n.values.push(o(i))}r.value.push(n)}return r}function s(e){for(var t=[],r=0;r<e.length;++r)t.push(i(e[r]));return t}function o(t){var r;if(t.type===e.pki.oids.contentType)r=u.create(u.Class.UNIVERSAL,u.Type.OID,!1,u.oidToDer(t.value).getBytes());else if(t.type===e.pki.oids.messageDigest)r=u.create(u.Class.UNIVERSAL,u.Type.OCTETSTRING,!1,t.value.bytes());else if(t.type===e.pki.oids.signingTime){var n=new Date("Jan 1, 1950 00:00:00Z"),a=new Date("Jan 1, 2050 00:00:00Z"),i=t.value;if("string"==typeof i){var s=Date.parse(i);i=isNaN(s)?13===i.length?u.utcTimeToDate(i):u.generalizedTimeToDate(i):new Date(s)}r=i>=n&&a>i?u.create(u.Class.UNIVERSAL,u.Type.UTCTIME,!1,u.dateToUtcTime(i)):u.create(u.Class.UNIVERSAL,u.Type.GENERALIZEDTIME,!1,u.dateToGeneralizedTime(i))}return u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[u.create(u.Class.UNIVERSAL,u.Type.OID,!1,u.oidToDer(t.type).getBytes()),u.create(u.Class.UNIVERSAL,u.Type.SET,!0,[r])])}function c(t){return[u.create(u.Class.UNIVERSAL,u.Type.OID,!1,u.oidToDer(e.pki.oids.data).getBytes()),u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[u.create(u.Class.UNIVERSAL,u.Type.OID,!1,u.oidToDer(t.algorithm).getBytes()),u.create(u.Class.UNIVERSAL,u.Type.OCTETSTRING,!1,t.parameter.getBytes())]),u.create(u.Class.CONTEXT_SPECIFIC,0,!0,[u.create(u.Class.UNIVERSAL,u.Type.OCTETSTRING,!1,t.content.getBytes())])]}function p(t,r,n){var a={},i=[];if(!u.validate(r,n,a,i)){var s=new Error("Cannot read PKCS#7 message. ASN.1 object is not a supported PKCS#7 message.");throw s.errors=s,s}var o=u.derToOid(a.contentType);if(o!==e.pki.oids.data)throw new Error("Unsupported PKCS#7 message. Only wrapped ContentType Data supported.");if(a.encryptedContent){var c="";if(e.util.isArray(a.encryptedContent))for(var p=0;p<a.encryptedContent.length;++p){if(a.encryptedContent[p].type!==u.Type.OCTETSTRING)throw new Error("Malformed PKCS#7 message, expecting encrypted content constructed of only OCTET STRING objects.");c+=a.encryptedContent[p].value}else c=a.encryptedContent;t.encryptedContent={algorithm:u.derToOid(a.encAlgorithm),parameter:e.util.createBuffer(a.encParameter.value),content:e.util.createBuffer(c)}}if(a.content){var c="";if(e.util.isArray(a.content))for(var p=0;p<a.content.length;++p){if(a.content[p].type!==u.Type.OCTETSTRING)throw new Error("Malformed PKCS#7 message, expecting content constructed of only OCTET STRING objects.");c+=a.content[p].value}else c=a.content;t.content=e.util.createBuffer(c)}return t.version=a.version.charCodeAt(0),t.rawCapture=a,a}function d(t){if(void 0===t.encryptedContent.key)throw new Error("Symmetric key not available.");if(void 0===t.content){var r;switch(t.encryptedContent.algorithm){case e.pki.oids["aes128-CBC"]:case e.pki.oids["aes192-CBC"]:case e.pki.oids["aes256-CBC"]:r=e.aes.createDecryptionCipher(t.encryptedContent.key);break;case e.pki.oids.desCBC:case e.pki.oids["des-EDE3-CBC"]:r=e.des.createDecryptionCipher(t.encryptedContent.key);break;default:throw new Error("Unsupported symmetric cipher, OID "+t.encryptedContent.algorithm)}if(r.start(t.encryptedContent.parameter),r.update(t.encryptedContent.content),!r.finish())throw new Error("Symmetric decryption failed.");t.content=r.output}}var u=e.asn1,l=e.pkcs7=e.pkcs7||{};l.messageFromPem=function(t){var r=e.pem.decode(t)[0];if("PKCS7"!==r.type){var n=new Error('Could not convert PKCS#7 message from PEM; PEM header type is not "PKCS#7".');throw n.headerType=r.type,n}if(r.procType&&"ENCRYPTED"===r.procType.type)throw new Error("Could not convert PKCS#7 message from PEM; PEM is encrypted.");var a=u.fromDer(r.body);return l.messageFromAsn1(a)},l.messageToPem=function(t,r){var n={type:"PKCS7",body:u.toDer(t.toAsn1()).getBytes()};return e.pem.encode(n,{maxline:r})},l.messageFromAsn1=function(t){var r={},n=[];if(!u.validate(t,l.asn1.contentInfoValidator,r,n)){var a=new Error("Cannot read PKCS#7 message. ASN.1 object is not an PKCS#7 ContentInfo.");throw a.errors=n,a}var i,s=u.derToOid(r.contentType);switch(s){case e.pki.oids.envelopedData:i=l.createEnvelopedData();break;case e.pki.oids.encryptedData:i=l.createEncryptedData();break;case e.pki.oids.signedData:i=l.createSignedData();break;default:throw new Error("Cannot read PKCS#7 message. ContentType with OID "+s+" is not (yet) supported.")}return i.fromAsn1(r.content.value[0]),i},l.createSignedData=function(){function t(){for(var t={},r=0;r<n.signers.length;++r){var a=n.signers[r],i=a.digestAlgorithm;i in t||(t[i]=e.md[e.pki.oids[i]].create()),a.md=0===a.authenticatedAttributes.length?t[i]:e.md[e.pki.oids[i]].create()}n.digestAlgorithmIdentifiers=[];for(var i in t)n.digestAlgorithmIdentifiers.push(u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[u.create(u.Class.UNIVERSAL,u.Type.OID,!1,u.oidToDer(i).getBytes()),u.create(u.Class.UNIVERSAL,u.Type.NULL,!1,"")]));return t}function r(t){if(n.contentInfo.value.length<2)throw new Error("Could not sign PKCS#7 message; there is no content to sign.");var r=u.derToOid(n.contentInfo.value[0].value),a=n.contentInfo.value[1];a=a.value[0];var i=u.toDer(a);i.getByte(),u.getBerValueLength(i),i=i.getBytes();for(var c in t)t[c].start().update(i);for(var p=new Date,d=0;d<n.signers.length;++d){var l=n.signers[d];if(0===l.authenticatedAttributes.length){if(r!==e.pki.oids.data)throw new Error("Invalid signer; authenticatedAttributes must be present when the ContentInfo content type is not PKCS#7 Data.")}else{l.authenticatedAttributesAsn1=u.create(u.Class.CONTEXT_SPECIFIC,0,!0,[]);for(var y=u.create(u.Class.UNIVERSAL,u.Type.SET,!0,[]),C=0;C<l.authenticatedAttributes.length;++C){var f=l.authenticatedAttributes[C];f.type===e.pki.oids.messageDigest?f.value=t[l.digestAlgorithm].digest():f.type===e.pki.oids.signingTime&&(f.value||(f.value=p)),y.value.push(o(f)),l.authenticatedAttributesAsn1.value.push(o(f))}i=u.toDer(y).getBytes(),l.md.start().update(i)}l.signature=l.key.sign(l.md,"RSASSA-PKCS1-V1_5")}n.signerInfos=s(n.signers)}var n=null;return n={type:e.pki.oids.signedData,version:1,certificates:[],crls:[],signers:[],digestAlgorithmIdentifiers:[],contentInfo:null,signerInfos:[],fromAsn1:function(t){p(n,t,l.asn1.signedDataValidator),n.certificates=[],n.crls=[],n.digestAlgorithmIdentifiers=[],n.contentInfo=null,n.signerInfos=[];for(var r=n.rawCapture.certificates.value,a=0;a<r.length;++a)n.certificates.push(e.pki.certificateFromAsn1(r[a]))},toAsn1:function(){n.contentInfo||n.sign();for(var t=[],r=0;r<n.certificates.length;++r)t.push(e.pki.certificateToAsn1(n.certificates[r]));var a=[],i=u.create(u.Class.CONTEXT_SPECIFIC,0,!0,[u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[u.create(u.Class.UNIVERSAL,u.Type.INTEGER,!1,u.integerToDer(n.version).getBytes()),u.create(u.Class.UNIVERSAL,u.Type.SET,!0,n.digestAlgorithmIdentifiers),n.contentInfo])]);return t.length>0&&i.value[0].value.push(u.create(u.Class.CONTEXT_SPECIFIC,0,!0,t)),a.length>0&&i.value[0].value.push(u.create(u.Class.CONTEXT_SPECIFIC,1,!0,a)),i.value[0].value.push(u.create(u.Class.UNIVERSAL,u.Type.SET,!0,n.signerInfos)),u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[u.create(u.Class.UNIVERSAL,u.Type.OID,!1,u.oidToDer(n.type).getBytes()),i])},addSigner:function(t){var r=t.issuer,a=t.serialNumber;if(t.certificate){var i=t.certificate;"string"==typeof i&&(i=e.pki.certificateFromPem(i)),r=i.issuer.attributes,a=i.serialNumber}var s=t.key;if(!s)throw new Error("Could not add PKCS#7 signer; no private key specified.");"string"==typeof s&&(s=e.pki.privateKeyFromPem(s));var o=t.digestAlgorithm||e.pki.oids.sha1;switch(o){case e.pki.oids.sha1:case e.pki.oids.sha256:case e.pki.oids.sha384:case e.pki.oids.sha512:case e.pki.oids.md5:break;default:throw new Error("Could not add PKCS#7 signer; unknown message digest algorithm: "+o)}var c=t.authenticatedAttributes||[];if(c.length>0){for(var p=!1,d=!1,u=0;u<c.length;++u){var l=c[u];if(p||l.type!==e.pki.oids.contentType){if(d||l.type!==e.pki.oids.messageDigest);else if(d=!0,p)break}else if(p=!0,d)break}if(!p||!d)throw new Error("Invalid signer.authenticatedAttributes. If signer.authenticatedAttributes is specified, then it must contain at least two attributes, PKCS #9 content-type and PKCS #9 message-digest.")}n.signers.push({key:s,version:1,issuer:r,serialNumber:a,digestAlgorithm:o,signatureAlgorithm:e.pki.oids.rsaEncryption,signature:null,authenticatedAttributes:c,unauthenticatedAttributes:[]})},sign:function(){if(("object"!=typeof n.content||null===n.contentInfo)&&(n.contentInfo=u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[u.create(u.Class.UNIVERSAL,u.Type.OID,!1,u.oidToDer(e.pki.oids.data).getBytes())]),"content"in n)){var a;n.content instanceof e.util.ByteBuffer?a=n.content.bytes():"string"==typeof n.content&&(a=e.util.encodeUtf8(n.content)),n.contentInfo.value.push(u.create(u.Class.CONTEXT_SPECIFIC,0,!0,[u.create(u.Class.UNIVERSAL,u.Type.OCTETSTRING,!1,a)]))}if(0!==n.signers.length){var i=t();r(i)}},verify:function(){throw new Error("PKCS#7 signature verification not yet implemented.")},addCertificate:function(t){"string"==typeof t&&(t=e.pki.certificateFromPem(t)),n.certificates.push(t)},addCertificateRevokationList:function(){throw new Error("PKCS#7 CRL support not yet implemented.")}}},l.createEncryptedData=function(){var t=null;return t={type:e.pki.oids.encryptedData,version:0,encryptedContent:{algorithm:e.pki.oids["aes256-CBC"]},fromAsn1:function(e){p(t,e,l.asn1.encryptedDataValidator)},decrypt:function(e){void 0!==e&&(t.encryptedContent.key=e),d(t)}}},l.createEnvelopedData=function(){var t=null;return t={type:e.pki.oids.envelopedData,version:0,recipients:[],encryptedContent:{algorithm:e.pki.oids["aes256-CBC"]},fromAsn1:function(e){var r=p(t,e,l.asn1.envelopedDataValidator);t.recipients=n(r.recipientInfos.value)},toAsn1:function(){return u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[u.create(u.Class.UNIVERSAL,u.Type.OID,!1,u.oidToDer(t.type).getBytes()),u.create(u.Class.CONTEXT_SPECIFIC,0,!0,[u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,[u.create(u.Class.UNIVERSAL,u.Type.INTEGER,!1,u.integerToDer(t.version).getBytes()),u.create(u.Class.UNIVERSAL,u.Type.SET,!0,a(t.recipients)),u.create(u.Class.UNIVERSAL,u.Type.SEQUENCE,!0,c(t.encryptedContent))])])])},findRecipient:function(e){for(var r=e.issuer.attributes,n=0;n<t.recipients.length;++n){var a=t.recipients[n],i=a.issuer;if(a.serialNumber===e.serialNumber&&i.length===r.length){for(var s=!0,o=0;o<r.length;++o)if(i[o].type!==r[o].type||i[o].value!==r[o].value){s=!1;break}if(s)return a}}return null},decrypt:function(r,n){if(void 0===t.encryptedContent.key&&void 0!==r&&void 0!==n)switch(r.encryptedContent.algorithm){case e.pki.oids.rsaEncryption:case e.pki.oids.desCBC:var a=n.decrypt(r.encryptedContent.content);t.encryptedContent.key=e.util.createBuffer(a);break;default:throw new Error("Unsupported asymmetric cipher, OID "+r.encryptedContent.algorithm)}d(t)},addRecipient:function(r){t.recipients.push({version:0,issuer:r.issuer.attributes,serialNumber:r.serialNumber,encryptedContent:{algorithm:e.pki.oids.rsaEncryption,key:r.publicKey}})},encrypt:function(r,n){if(void 0===t.encryptedContent.content){n=n||t.encryptedContent.algorithm,r=r||t.encryptedContent.key;var a,i,s;switch(n){case e.pki.oids["aes128-CBC"]:a=16,i=16,s=e.aes.createEncryptionCipher;break;case e.pki.oids["aes192-CBC"]:a=24,i=16,s=e.aes.createEncryptionCipher;break;case e.pki.oids["aes256-CBC"]:a=32,i=16,s=e.aes.createEncryptionCipher;break;case e.pki.oids["des-EDE3-CBC"]:a=24,i=8,s=e.des.createEncryptionCipher;break;default:throw new Error("Unsupported symmetric cipher, OID "+n)}if(void 0===r)r=e.util.createBuffer(e.random.getBytes(a));else if(r.length()!=a)throw new Error("Symmetric key has wrong length; got "+r.length()+" bytes, expected "+a+".");t.encryptedContent.algorithm=n,t.encryptedContent.key=r,t.encryptedContent.parameter=e.util.createBuffer(e.random.getBytes(i));var o=s(r);if(o.start(t.encryptedContent.parameter.copy()),o.update(t.content),!o.finish())throw new Error("Symmetric encryption failed.");t.encryptedContent.content=o.output}for(var c=0;c<t.recipients.length;++c){var p=t.recipients[c];if(void 0===p.encryptedContent.content)switch(p.encryptedContent.algorithm){case e.pki.oids.rsaEncryption:p.encryptedContent.content=p.encryptedContent.key.encrypt(t.encryptedContent.key.data);break;default:throw new Error("Unsupported asymmetric cipher, OID "+p.encryptedContent.algorithm)}}}}}}var t="pkcs7";if("function"!=typeof define){if("object"!=typeof module||!module.exports)return"undefined"==typeof forge&&(forge={}),e(forge);var r=!0;define=function(e,t){t(require,module)}}var n,a=function(r,a){a.exports=function(a){var i=n.map(function(e){return r(e)}).concat(e);if(a=a||{},a.defined=a.defined||{},a.defined[t])return a[t];a.defined[t]=!0;for(var s=0;s<i.length;++s)i[s](a);return a[t]}},i=define;define=function(e,t){return n="string"==typeof e?t.slice(2):e.slice(2),r?(delete define,i.apply(null,Array.prototype.slice.call(arguments,0))):(define=i,define.apply(null,Array.prototype.slice.call(arguments,0)))},define(["require","module","./aes","./asn1","./des","./oids","./pem","./pkcs7asn1","./random","./util","./x509"],function(){a.apply(null,Array.prototype.slice.call(arguments,0))})}();