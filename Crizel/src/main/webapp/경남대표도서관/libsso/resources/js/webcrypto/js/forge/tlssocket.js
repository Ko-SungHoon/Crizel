/**
 * Socket wrapping functions for TLS.
 *
 * @author Dave Longley
 *
 * Copyright (c) 2009-2012 Digital Bazaar, Inc.
 */
!function(){function e(e){e.tls.wrapSocket=function(t){var n=t.socket,i={id:n.id,connected:n.connected||function(){},closed:n.closed||function(){},data:n.data||function(){},error:n.error||function(){}},o=e.tls.createConnection({server:!1,sessionId:t.sessionId||null,caStore:t.caStore||[],sessionCache:t.sessionCache||null,cipherSuites:t.cipherSuites||null,virtualHost:t.virtualHost,verify:t.verify,getCertificate:t.getCertificate,getPrivateKey:t.getPrivateKey,getSignature:t.getSignature,deflate:t.deflate,inflate:t.inflate,connected:function(e){1===e.handshakes&&i.connected({id:n.id,type:"connect",bytesAvailable:e.data.length()})},tlsDataReady:function(e){return n.send(e.tlsData.getBytes())},dataReady:function(e){i.data({id:n.id,type:"socketData",bytesAvailable:e.data.length()})},closed:function(){n.close()},error:function(e,t){i.error({id:n.id,type:"tlsError",message:t.message,bytesAvailable:0,error:t}),n.close()}});n.connected=function(){o.handshake(t.sessionId)},n.closed=function(){o.open&&o.handshaking&&i.error({id:n.id,type:"ioError",message:"Connection closed during handshake.",bytesAvailable:0}),o.close(),i.closed({id:n.id,type:"close",bytesAvailable:0})},n.error=function(e){i.error({id:n.id,type:e.type,message:e.message,bytesAvailable:0}),o.close()};var r=0;return n.data=function(e){if(o.open){if(e.bytesAvailable>=r){var t=Math.max(e.bytesAvailable,r),i=n.receive(t);null!==i&&(r=o.process(i))}}else n.receive(e.bytesAvailable)},i.destroy=function(){n.destroy()},i.setSessionCache=function(e){o.sessionCache=tls.createSessionCache(e)},i.connect=function(e){n.connect(e)},i.close=function(){o.close()},i.isConnected=function(){return o.isConnected&&n.isConnected()},i.send=function(e){return o.prepare(e)},i.receive=function(e){return o.data.getBytes(e)},i.bytesAvailable=function(){return o.data.length()},i}}var t="tlssocket";if("function"!=typeof define){if("object"!=typeof module||!module.exports)return"undefined"==typeof forge&&(forge={}),e(forge);var n=!0;define=function(e,t){t(require,module)}}var i,o=function(n,o){o.exports=function(o){var r=i.map(function(e){return n(e)}).concat(e);if(o=o||{},o.defined=o.defined||{},o.defined[t])return o[t];o.defined[t]=!0;for(var a=0;a<r.length;++a)r[a](o);return o[t]}},r=define;define=function(e,t){return i="string"==typeof e?t.slice(2):e.slice(2),n?(delete define,r.apply(null,Array.prototype.slice.call(arguments,0))):(define=r,define.apply(null,Array.prototype.slice.call(arguments,0)))},define(["require","module","./tls"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}();