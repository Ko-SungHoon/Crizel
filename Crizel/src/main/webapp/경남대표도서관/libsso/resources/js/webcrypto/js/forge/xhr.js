/**
 * XmlHttpRequest implementation that uses TLS and flash SocketPool.
 *
 * @author Dave Longley
 *
 * Copyright (c) 2010-2013 Digital Bazaar, Inc.
 */
!function(e){var r="forge.xhr",t=0,o=1,n=2,s=3,a=4,i=null,l=0,u=null,c=null,g={},d=10;"undefined"==typeof forge&&(forge={});var f=forge.net,p=forge.http,y={};y.init=function(e){forge.log.debug(r,"initializing",e),l=e.policyPort||l,u=e.policyUrl||u,d=e.connections||d,i=f.createSocketPool({flashId:e.flashId,policyPort:l,policyUrl:u,msie:e.msie||!1}),c=p.createClient({url:e.url||window.location.protocol+"//"+window.location.host,socketPool:i,policyPort:l,policyUrl:u,connections:e.connections||d,caCerts:e.caCerts,cipherSuites:e.cipherSuites,persistCookies:e.persistCookies||!0,primeTlsSockets:e.primeTlsSockets||!1,verify:e.verify,getCertificate:e.getCertificate,getPrivateKey:e.getPrivateKey,getSignature:e.getSignature}),g[c.url.full]=c,forge.log.debug(r,"ready")},y.cleanup=function(){for(var e in g)g[e].destroy();g={},c=null,i.destroy(),i=null},y.setCookie=function(e){if(e.maxAge=e.maxAge||-1,e.domain)for(var r in g){var t=g[r];p.withinCookieDomain(t.url,e)&&t.secure===e.secure&&t.setCookie(e)}else c.setCookie(e)},y.getCookie=function(e,r,t){var o=null;if(t)for(var n in g){var s=g[n];if(p.withinCookieDomain(s.url,t)){var a=s.getCookie(e,r);null!==a&&(null===o?o=a:forge.util.isArray(o)?o.push(a):o=[o,a])}}else o=c.getCookie(e,r);return o},y.removeCookie=function(e,r,t){var o=!1;if(t)for(var n in g){var s=g[n];p.withinCookieDomain(s.url,t)&&s.removeCookie(e,r)&&(o=!0)}else o=c.removeCookie(e,r);return o},y.create=function(f){f=e.extend({logWarningOnError:!0,verbose:!1,logError:function(){},logWarning:function(){},logDebug:function(){},logVerbose:function(){},url:null},f||{});var y={client:null,request:null,response:null,asynchronous:!0,sendFlag:!1,errorFlag:!1},h={error:f.logError||forge.log.error,warning:f.logWarning||forge.log.warning,debug:f.logDebug||forge.log.debug,verbose:f.logVerbose||forge.log.verbose},v={onreadystatechange:null,readyState:t,responseText:"",responseXML:null,status:0,statusText:""};if(null===f.url)y.client=c;else{var C=p.parseUrl(f.url);if(!C){var m=new Error("Invalid url.");m.details={url:f.url}}C.full in g?y.client=g[C.full]:(y.client=p.createClient({url:f.url,socketPool:i,policyPort:f.policyPort||l,policyUrl:f.policyUrl||u,connections:f.connections||d,caCerts:f.caCerts,cipherSuites:f.cipherSuites,persistCookies:f.persistCookies||!0,primeTlsSockets:f.primeTlsSockets||!1,verify:f.verify,getCertificate:f.getCertificate,getPrivateKey:f.getPrivateKey,getSignature:f.getSignature}),g[C.full]=y.client)}return v.open=function(e,r){switch(e){case"DELETE":case"GET":case"HEAD":case"OPTIONS":case"PATCH":case"POST":case"PUT":break;case"CONNECT":case"TRACE":case"TRACK":throw new Error("CONNECT, TRACE and TRACK methods are disallowed");default:throw new Error("Invalid method: "+e)}y.sendFlag=!1,v.responseText="",v.responseXML=null,v.status=0,v.statusText="",y.request=p.createRequest({method:e,path:r}),v.readyState=o,v.onreadystatechange&&v.onreadystatechange()},v.setRequestHeader=function(e,r){if(v.readyState!=o||y.sendFlag)throw new Error("XHR not open or sending");y.request.setField(e,r)},v.send=function(e){if(v.readyState!=o||y.sendFlag)throw new Error("XHR not open or sending");if(e&&"GET"!==y.request.method&&"HEAD"!==y.request.method)if("undefined"!=typeof XMLSerializer)if(e instanceof Document){var t=new XMLSerializer;y.request.body=t.serializeToString(e)}else y.request.body=e;else y.request.body="undefined"!=typeof e.xml?e.xml:e;y.errorFlag=!1,y.sendFlag=!0,v.onreadystatechange&&v.onreadystatechange();var i={};i.request=y.request,i.headerReady=function(e){v.cookies=y.client.cookies,v.readyState=n,v.status=e.response.code,v.statusText=e.response.message,y.response=e.response,v.onreadystatechange&&v.onreadystatechange(),y.response.aborted||(v.readyState=s,v.onreadystatechange&&v.onreadystatechange())},i.bodyReady=function(e){v.readyState=a;var t=e.response.getField("Content-Type");if(t&&(0===t.indexOf("text/xml")||0===t.indexOf("application/xml")||-1!==t.indexOf("+xml")))try{var o=new ActiveXObject("MicrosoftXMLDOM");o.async=!1,o.loadXML(e.response.body),v.responseXML=o}catch(n){var s=new DOMParser;v.responseXML=s.parseFromString(n.body,"text/xml")}var l=0;null!==e.response.body&&(v.responseText=e.response.body,l=e.response.body.length);var u,c=y.request,g=c.method+" "+c.path+" "+v.status+" "+v.statusText+" "+l+"B "+(e.request.connectTime+e.request.time+e.response.time)+"ms";i.verbose?(u=v.status>=400&&i.logWarningOnError?h.warning:h.verbose)(r,g,e,e.response.body?"\n"+e.response.body:"\nNo content"):(u=v.status>=400&&i.logWarningOnError?h.warning:h.debug)(r,g),v.onreadystatechange&&v.onreadystatechange()},i.error=function(e){var t=y.request;h.error(r,t.method+" "+t.path,e),v.responseText="",v.responseXML=null,y.errorFlag=!0,v.status=0,v.statusText="",v.readyState=a,v.onreadystatechange&&v.onreadystatechange()},y.client.send(i)},v.abort=function(){y.request.abort(),v.responseText="",v.responseXML=null,y.errorFlag=!0,v.status=0,v.statusText="",y.request=null,y.response=null,v.readyState===a||v.readyState===t||v.readyState===o&&!y.sendFlag?v.readyState=t:(v.readyState=a,y.sendFlag=!1,v.onreadystatechange&&v.onreadystatechange(),v.readyState=t)},v.getAllResponseHeaders=function(){var r="";if(null!==y.response){var t=y.response.fields;e.each(t,function(t,o){e.each(o,function(e,o){r+=t+": "+o+"\r\n"})})}return r},v.getResponseHeader=function(e){var r=null;return null!==y.response&&e in y.response.fields&&(r=y.response.fields[e],forge.util.isArray(r)&&(r=r.join())),r},v},forge.xhr=y}(jQuery);