/**
 * Password-based encryption functions.
 *
 * @author Dave Longley
 * @author Stefan Siegl <stesie@brokenpipe.de>
 *
 * Copyright (c) 2010-2013 Digital Bazaar, Inc.
 * Copyright (c) 2012 Stefan Siegl <stesie@brokenpipe.de>
 *
 * An EncryptedPrivateKeyInfo:
 *
 * EncryptedPrivateKeyInfo ::= SEQUENCE {
 *   encryptionAlgorithm  EncryptionAlgorithmIdentifier,
 *   encryptedData        EncryptedData }
 *
 * EncryptionAlgorithmIdentifier ::= AlgorithmIdentifier
 *
 * EncryptedData ::= OCTET STRING
 */
!function(){function e(e){function t(e,t){return e.start().update(t).digest().getBytes()}if("undefined"==typeof r)var r=e.jsbn.BigInteger;var a=e.asn1,s=e.pki=e.pki||{};s.pbe=e.pbe=e.pbe||{};var n=s.oids,o={name:"EncryptedPrivateKeyInfo",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedPrivateKeyInfo.encryptionAlgorithm",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:a.Class.UNIVERSAL,type:a.Type.OID,constructed:!1,capture:"encryptionOid"},{name:"AlgorithmIdentifier.parameters",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,captureAsn1:"encryptionParams"}]},{name:"EncryptedPrivateKeyInfo.encryptedData",tagClass:a.Class.UNIVERSAL,type:a.Type.OCTETSTRING,constructed:!1,capture:"encryptedData"}]},i={name:"PBES2Algorithms",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.keyDerivationFunc",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.keyDerivationFunc.oid",tagClass:a.Class.UNIVERSAL,type:a.Type.OID,constructed:!1,capture:"kdfOid"},{name:"PBES2Algorithms.params",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.params.salt",tagClass:a.Class.UNIVERSAL,type:a.Type.OCTETSTRING,constructed:!1,capture:"kdfSalt"},{name:"PBES2Algorithms.params.iterationCount",tagClass:a.Class.UNIVERSAL,type:a.Type.INTEGER,onstructed:!0,capture:"kdfIterationCount"}]}]},{name:"PBES2Algorithms.encryptionScheme",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.encryptionScheme.oid",tagClass:a.Class.UNIVERSAL,type:a.Type.OID,constructed:!1,capture:"encOid"},{name:"PBES2Algorithms.encryptionScheme.iv",tagClass:a.Class.UNIVERSAL,type:a.Type.OCTETSTRING,constructed:!1,capture:"encIv"}]}]},p={name:"pkcs-12PbeParams",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"pkcs-12PbeParams.salt",tagClass:a.Class.UNIVERSAL,type:a.Type.OCTETSTRING,constructed:!1,capture:"salt"},{name:"pkcs-12PbeParams.iterations",tagClass:a.Class.UNIVERSAL,type:a.Type.INTEGER,constructed:!1,capture:"iterations"}]},c={name:"PBEParameter",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"PBEParameter.salt",tagClass:a.Class.UNIVERSAL,type:a.Type.OCTETSTRING,constructed:!1,capture:"salt"},{name:"PBEParameter.iterationCount",tagClass:a.Class.UNIVERSAL,type:a.Type.INTEGER,constructed:!1,capture:"iterationCount"}]};s.checkEncAlgorithmOfPrivKey=function(e){var t={};t.algorithm="PBES2",t.options={},t.options.saltSize=8,t.options.count=2048,t.options.algorithm="seed";var r={},n=[];if(!a.validate(e,o,r,n)){var i=new Error("Cannot read encrypted private key. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");return i.errors=n,i}var p=a.derToOid(r.encryptionOid);switch(p){case s.oids.seedCBCWithSHA1:return t.algorithm="PBES1",t.options.algorithm="seedWithSHA1",t;case s.oids.seedCBC:return t.algorithm="PBES1",t.options.algorithm="seed",t;case s.oids.pkcs5PBES2:var c=s.pbe.getOptionsForPBES2(r.encryptionParams);if("object"==typeof c&&c.constructor===Error){var i=c;return i}return t.algorithm="PBES2",t.options=c,t;default:var i=new Error("Cannot read encrypted PBE data block. Unsupported OID.");return i.oid=p,i.supportedOids=["seedCBCWithSHA1","seedCBC","pkcs5PBES2"],i}},s.pbe.getOptionsForPBES2=function(e){var t={};t.saltSize=8,t.count=2048,t.algorithm="seed";var r={},n=[];if(!a.validate(e,i,r,n)){var o=new Error("Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");return o.errors=n,o}var p=a.derToOid(r.kdfOid);if(p!==s.oids.pkcs5PBKDF2){var o=new Error("Cannot read encrypted private key. Unsupported key derivation function OID.");return o.oid=p,o.supportedOids=["pkcs5PBKDF2"],o}switch(p=a.derToOid(r.encOid),s.oids[p]){case"seedCBC":return t.algorithm="seed",t;case"aes128-CBC":return t.algorithm="aes128",t;case"aes192-CBC":return t.algorithm="aes192",t;case"aes256-CBC":return t.algorithm="aes256",t;case"desCBC":return t.algorithm="des",t;default:var o=new Error("Unsupported encryption scheme OID.");return o.oid=p,o.supportedOids=["seedCBC","aes128-CBC","aes192-CBC","aes256-CBC","desCBC"],o}},s.encryptPrivKeyInfoPBES1=function(t,r,s){s=s||{},s.saltSize=s.saltSize||8,s.count=s.count||2048,s.algorithm=s.algorithm||"seedWithSHA1";var o,i,p,c,d=e.random.getBytesSync(s.saltSize),C=s.count,y=a.integerToDer(C);switch(s.algorithm){case"seedWithSHA1":c=function(){var t=e.pkcs5.pbkdf1(r,d,C,20),a=t.slice(0,16),s=e.md.sha1.create().update(t.slice(16)).digest().getBytes();s=s.slice(0,16);var n=e.seed.createEncryptionCipher(a);return n.start(s),n},p=n.seedCBCWithSHA1;break;case"seed":c=function(){var t=e.pkcs5.pbkdf1(r,d,C,16),a="0123456789012345",s=e.seed.createEncryptionCipher(t);return s.start(a),s},p=n.seedCBC;break;default:var E=new Error("Cannot encrypt private key. Unknown encryption algorithm.");return E.algorithm=s.algorithm,E}var u=c();u.update(a.toDer(t)),u.finish(),i=u.output.getBytes(),o=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(p).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,d),a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,y.getBytes())])]);var l=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[o,a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,i)]);return l},s.encryptPrivateKeyInfo=function(t,r,o){o=o||{},o.saltSize=o.saltSize||8,o.count=o.count||2048,o.algorithm=o.algorithm||"aes128";var i,p,c,d=e.random.getBytesSync(o.saltSize),C=o.count,y=a.integerToDer(C);if("seed"===o.algorithm||0===o.algorithm.indexOf("aes")||"des"===o.algorithm){var E,u,l;switch(o.algorithm){case"seed":i=16,E=16,u=n.seedCBC,l=e.seed.createEncryptionCipher;break;case"aes128":i=16,E=16,u=n["aes128-CBC"],l=e.aes.createEncryptionCipher;break;case"aes192":i=24,E=16,u=n["aes192-CBC"],l=e.aes.createEncryptionCipher;break;case"aes256":i=32,E=16,u=n["aes256-CBC"],l=e.aes.createEncryptionCipher;break;case"des":i=8,E=8,u=n.desCBC,l=e.des.createEncryptionCipher;break;default:var f=new Error("Cannot encrypt private key. Unknown encryption algorithm.");throw f.algorithm=o.algorithm,f}var h=e.pkcs5.pbkdf2(r,d,C,i),B=e.random.getBytesSync(E),S=l(h);S.start(B),S.update(a.toDer(t)),S.finish(),c=S.output.getBytes(),p=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(n.pkcs5PBES2).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(n.pkcs5PBKDF2).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,d),a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,y.getBytes())])]),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(u).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,B)])])])}else{if("3des"!==o.algorithm){var f=new Error("Cannot encrypt private key. Unknown encryption algorithm.");throw f.algorithm=o.algorithm,f}i=24;var g=new e.util.ByteBuffer(d),h=s.pbe.generatePkcs12Key(r,g,1,C,i),B=s.pbe.generatePkcs12Key(r,g,2,C,i),S=e.des.createEncryptionCipher(h);S.start(B),S.update(a.toDer(t)),S.finish(),c=S.output.getBytes(),p=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(n["pbeWithSHAAnd3-KeyTripleDES-CBC"]).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,d),a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,y.getBytes())])])}var v=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[p,a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,c)]);return v},s.encryptPrivKeyInfoPBES2=s.encryptPrivateKeyInfo,s.decryptPrivateKeyInfo=function(t,r){var n=null,i={},p=[];if(!a.validate(t,o,i,p)){var c=new Error("Cannot read encrypted private key. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw c.errors=p,c}var d=a.derToOid(i.encryptionOid),C=s.pbe.getCipher(d,i.encryptionParams,r),y=e.util.createBuffer(i.encryptedData);return C.update(y),C.finish()&&(n=a.fromDer(C.output)),n},s.encryptedPrivateKeyToPem=function(t,r){var s={type:"ENCRYPTED PRIVATE KEY",body:a.toDer(t).getBytes()};return e.pem.encode(s,{maxline:r})},s.encryptedPrivateKeyFromPem=function(t){var r=e.pem.decode(t)[0];if("ENCRYPTED PRIVATE KEY"!==r.type){var s=new Error('Could not convert encrypted private key from PEM; PEM header type is "ENCRYPTED PRIVATE KEY".');throw s.headerType=r.type,s}if(r.procType&&"ENCRYPTED"===r.procType.type)throw new Error("Could not convert encrypted private key from PEM; PEM is encrypted.");return a.fromDer(r.body)},s.encryptRsaPrivateKey=function(t,r,n){if(n=n||{},!n.legacy){var o=s.wrapRsaPrivateKey(s.privateKeyToAsn1(t));return o=s.encryptPrivateKeyInfo(o,r,n),s.encryptedPrivateKeyToPem(o)}var i,p,c,d;switch(n.algorithm){case"aes128":i="AES-128-CBC",c=16,p=e.random.getBytesSync(16),d=e.aes.createEncryptionCipher;break;case"aes192":i="AES-192-CBC",c=24,p=e.random.getBytesSync(16),d=e.aes.createEncryptionCipher;break;case"aes256":i="AES-256-CBC",c=32,p=e.random.getBytesSync(16),d=e.aes.createEncryptionCipher;break;case"3des":i="DES-EDE3-CBC",c=24,p=e.random.getBytesSync(8),d=e.des.createEncryptionCipher;break;case"des":i="DES-CBC",c=8,p=e.random.getBytesSync(8),d=e.des.createEncryptionCipher;break;default:var C=new Error('Could not encrypt RSA private key; unsupported encryption algorithm "'+n.algorithm+'".');throw C.algorithm=n.algorithm,C}var y=e.pbe.opensslDeriveBytes(r,p.substr(0,8),c),E=d(y);E.start(p),E.update(a.toDer(s.privateKeyToAsn1(t))),E.finish();var u={type:"RSA PRIVATE KEY",procType:{version:"4",type:"ENCRYPTED"},dekInfo:{algorithm:i,parameters:e.util.bytesToHex(p).toUpperCase()},body:E.output.getBytes()};return e.pem.encode(u)},s.decryptRsaPrivateKey=function(t,r){var n=null,o=e.pem.decode(t)[0];if("ENCRYPTED PRIVATE KEY"!==o.type&&"PRIVATE KEY"!==o.type&&"RSA PRIVATE KEY"!==o.type){var i=new Error('Could not convert private key from PEM; PEM header type is not "ENCRYPTED PRIVATE KEY", "PRIVATE KEY", or "RSA PRIVATE KEY".');throw i.headerType=i,i}if(o.procType&&"ENCRYPTED"===o.procType.type){var p,c;switch(o.dekInfo.algorithm){case"DES-CBC":p=8,c=e.des.createDecryptionCipher;break;case"DES-EDE3-CBC":p=24,c=e.des.createDecryptionCipher;break;case"AES-128-CBC":p=16,c=e.aes.createDecryptionCipher;break;case"AES-192-CBC":p=24,c=e.aes.createDecryptionCipher;break;case"AES-256-CBC":p=32,c=e.aes.createDecryptionCipher;break;case"RC2-40-CBC":p=5,c=function(t){return e.rc2.createDecryptionCipher(t,40)};break;case"RC2-64-CBC":p=8,c=function(t){return e.rc2.createDecryptionCipher(t,64)};break;case"RC2-128-CBC":p=16,c=function(t){return e.rc2.createDecryptionCipher(t,128)};break;default:var i=new Error('Could not decrypt private key; unsupported encryption algorithm "'+o.dekInfo.algorithm+'".');throw i.algorithm=o.dekInfo.algorithm,i}var d=e.util.hexToBytes(o.dekInfo.parameters),C=e.pbe.opensslDeriveBytes(r,d.substr(0,8),p),y=c(C);if(y.start(d),y.update(e.util.createBuffer(o.body)),!y.finish())return n;n=y.output.getBytes()}else n=o.body;return n="ENCRYPTED PRIVATE KEY"===o.type?s.decryptPrivateKeyInfo(a.fromDer(n),r):a.fromDer(n),null!==n&&(n=s.privateKeyFromAsn1(n)),n},s.pbe.generatePkcs12Key=function(t,r,a,s,n,o){var i,p;("undefined"==typeof o||null===o)&&(o=e.md.sha1.create());var c=o.digestLength,d=o.blockLength,C=new e.util.ByteBuffer,y=new e.util.ByteBuffer;if(null!==t&&void 0!==t){for(p=0;p<t.length;p++)y.putInt16(t.charCodeAt(p));y.putInt16(0)}var E=y.length(),u=r.length(),l=new e.util.ByteBuffer;l.fillWithByte(a,d);var f=d*Math.ceil(u/d),h=new e.util.ByteBuffer;for(p=0;f>p;p++)h.putByte(r.at(p%u));var B=d*Math.ceil(E/d),S=new e.util.ByteBuffer;for(p=0;B>p;p++)S.putByte(y.at(p%E));var g=h;g.putBuffer(S);for(var v=Math.ceil(n/c),m=1;v>=m;m++){var T=new e.util.ByteBuffer;T.putBytes(l.bytes()),T.putBytes(g.bytes());for(var I=0;s>I;I++)o.start(),o.update(T.getBytes()),T=o.digest();var A=new e.util.ByteBuffer;for(p=0;d>p;p++)A.putByte(T.at(p%c));var P=Math.ceil(u/d)+Math.ceil(E/d),k=new e.util.ByteBuffer;for(i=0;P>i;i++){var b=new e.util.ByteBuffer(g.getBytes(d)),N=511;for(p=A.length()-1;p>=0;p--)N>>=8,N+=A.at(p)+b.at(p),b.setAt(p,255&N);k.putBuffer(b)}g=k,C.putBuffer(T)}return C.truncate(C.length()-n),C},s.pbe.getCipher=function(e,t,r){switch(e){case s.oids.seedCBCWithSHA1:case s.oids.seedCBC:return s.pbe.getCipherForPBES1(e,t,r);case s.oids.pkcs5PBES2:return s.pbe.getCipherForPBES2(e,t,r);case s.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]:case s.oids["pbewithSHAAnd40BitRC2-CBC"]:return s.pbe.getCipherForPKCS12PBE(e,t,r);default:var a=new Error("Cannot read encrypted PBE data block. Unsupported OID.");throw a.oid=e,a.supportedOids=["seedCBCWithSHA1","seedCBC","pkcs5PBES2","pbeWithSHAAnd3-KeyTripleDES-CBC","pbewithSHAAnd40BitRC2-CBC"],a}},s.pbe.getCipherForPBES2=function(t,r,n){var o={},p=[];if(!a.validate(r,i,o,p)){var c=new Error("Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw c.errors=p,c}if(t=a.derToOid(o.kdfOid),t!==s.oids.pkcs5PBKDF2){var c=new Error("Cannot read encrypted private key. Unsupported key derivation function OID.");throw c.oid=t,c.supportedOids=["pkcs5PBKDF2"],c}if(t=a.derToOid(o.encOid),t!==s.oids.seedCBC&&t!==s.oids["aes128-CBC"]&&t!==s.oids["aes192-CBC"]&&t!==s.oids["aes256-CBC"]&&t!==s.oids["des-EDE3-CBC"]&&t!==s.oids.desCBC){var c=new Error("Cannot read encrypted private key. Unsupported encryption scheme OID.");throw c.oid=t,c.supportedOids=["seedCBC","aes128-CBC","aes192-CBC","aes256-CBC","des-EDE3-CBC","desCBC"],c}var d=o.kdfSalt,C=e.util.createBuffer(o.kdfIterationCount);C=C.getInt(C.length()<<3);var y,E;switch(s.oids[t]){case"seedCBC":y=16,E=e.seed.createDecryptionCipher;break;case"aes128-CBC":y=16,E=e.aes.createDecryptionCipher;break;case"aes192-CBC":y=24,E=e.aes.createDecryptionCipher;break;case"aes256-CBC":y=32,E=e.aes.createDecryptionCipher;break;case"des-EDE3-CBC":y=24,E=e.des.createDecryptionCipher;break;case"desCBC":y=8,E=e.des.createDecryptionCipher}var u=e.pkcs5.pbkdf2(n,d,C,y),l=o.encIv,f=E(u);return f.start(l),f},s.pbe.getCipherForPBES1=function(t,r,n){var o={},i=[];if(!a.validate(r,c,o,i)){var p=new Error("Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw p.errors=i,p}var d=o.salt,C=e.util.createBuffer(o.iterationCount);C=C.getInt(C.length()<<3);var y;switch(t){case s.oids.seedCBCWithSHA1:y=function(){var t=e.pkcs5.pbkdf1(n,d,C,20),r=t.slice(0,16),a=e.md.sha1.create().update(t.slice(16)).digest().getBytes();a=a.slice(0,16);var s=e.seed.createDecryptionCipher(r);return s.start(a),s};break;case s.oids.seedCBC:y=function(){var t=e.pkcs5.pbkdf1(n,d,C,16),r="0123456789012345",a=e.seed.createDecryptionCipher(t);return a.start(r),a};break;default:var p=new Error("Cannot read PBEParameter block. Unsupported PBES1Algorithms OID.");throw p.oid=t,p}return y()},s.pbe.getCipherForPKCS12PBE=function(t,r,n){var o={},i=[];if(!a.validate(r,p,o,i)){var c=new Error("Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw c.errors=i,c}var d=e.util.createBuffer(o.salt),C=e.util.createBuffer(o.iterations);C=C.getInt(C.length()<<3);var y,E,u;switch(t){case s.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]:y=24,E=8,u=e.des.startDecrypting;break;case s.oids["pbewithSHAAnd40BitRC2-CBC"]:y=5,E=8,u=function(t,r){var a=e.rc2.createDecryptionCipher(t,40);return a.start(r,null),a};break;default:var c=new Error("Cannot read PKCS #12 PBE data block. Unsupported OID.");throw c.oid=t,c}var l=s.pbe.generatePkcs12Key(n,d,1,C,y),f=s.pbe.generatePkcs12Key(n,d,2,C,E);return u(l,f)},s.pbe.opensslDeriveBytes=function(r,a,s,n){("undefined"==typeof n||null===n)&&(n=e.md.md5.create()),null===a&&(a="");for(var o=[t(n,r+a)],i=16,p=1;s>i;++p,i+=16)o.push(t(n,o[p-1]+r+a));return o.join("").substr(0,s)}}var t="pbe";if("function"!=typeof define){if("object"!=typeof module||!module.exports)return"undefined"==typeof forge&&(forge={}),e(forge);var r=!0;define=function(e,t){t(require,module)}}var a,s=function(r,s){s.exports=function(s){var n=a.map(function(e){return r(e)}).concat(e);if(s=s||{},s.defined=s.defined||{},s.defined[t])return s[t];s.defined[t]=!0;for(var o=0;o<n.length;++o)n[o](s);return s[t]}},n=define;define=function(e,t){return a="string"==typeof e?t.slice(2):e.slice(2),r?(delete define,n.apply(null,Array.prototype.slice.call(arguments,0))):(define=n,define.apply(null,Array.prototype.slice.call(arguments,0)))},define(["require","module","./aes","./asn1","./des","./md","./oids","./pem","./pbkdf2","./random","./rc2","./rsa","./util"],function(){s.apply(null,Array.prototype.slice.call(arguments,0))})}();