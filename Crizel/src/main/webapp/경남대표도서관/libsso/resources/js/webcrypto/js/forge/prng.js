/**
 * A javascript implementation of a cryptographically-secure
 * Pseudo Random Number Generator (PRNG). The Fortuna algorithm is followed
 * here though the use of SHA-256 is not enforced; when generating an
 * a PRNG context, the hashing algorithm and block cipher used for
 * the generator are specified via a plugin.
 *
 * @author Dave Longley
 *
 * Copyright (c) 2010-2014 Digital Bazaar, Inc.
 */
!function(){function e(e){var n="undefined"!=typeof process&&process.versions&&process.versions.node,r=null;e.disableNativeCode||!n||process.versions["node-webkit"]||(r=require("crypto"));var t=e.prng=e.prng||{};t.create=function(n){function t(e){if(s.pools[0].messageLength>=32)return i(),e();var n=32-s.pools[0].messageLength<<5;s.seedFile(n,function(n,r){return n?e(n):(s.collect(r),i(),void e())})}function o(){if(s.pools[0].messageLength>=32)return i();var e=32-s.pools[0].messageLength<<5;s.collect(s.seedFileSync(e)),i()}function i(){var e=s.plugin.md.create();e.update(s.pools[0].digest().getBytes()),s.pools[0].start();for(var n=1,r=1;32>r;++r)n=31===n?2147483648:n<<2,n%s.reseeds===0&&(e.update(s.pools[r].digest().getBytes()),s.pools[r].start());var t=e.digest().getBytes();e.start(),e.update(t);var o=e.digest().getBytes();s.key=s.plugin.formatKey(t),s.seed=s.plugin.formatSeed(o),s.reseeds=4294967295===s.reseeds?0:s.reseeds+1,s.generated=0}function l(n){var r=null;if("undefined"!=typeof window){var t=window.crypto||window.msCrypto;t&&t.getRandomValues&&(r=function(e){return t.getRandomValues(e)})}var o=e.util.createBuffer();if(r)for(;o.length()<n;){var i=Math.max(1,Math.min(n-o.length(),65536)/4),l=new Uint32Array(Math.floor(i));try{r(l);for(var s=0;s<l.length;++s)o.putInt32(l[s])}catch(a){if(!("undefined"!=typeof QuotaExceededError&&a instanceof QuotaExceededError))throw a}}if(o.length()<n)for(var u,f,d,g=Math.floor(65536*Math.random());o.length()<n;){f=16807*(65535&g),u=16807*(g>>16),f+=(32767&u)<<16,f+=u>>15,f=(2147483647&f)+(f>>31),g=4294967295&f;for(var s=0;3>s;++s)d=g>>>(s<<3),d^=Math.floor(256*Math.random()),o.putByte(String.fromCharCode(255&d))}return o.getBytes(n)}for(var s={plugin:n,key:null,seed:null,time:null,reseeds:0,generated:0},a=n.md,u=new Array(32),f=0;32>f;++f)u[f]=a.create();return s.pools=u,s.pool=0,s.generate=function(n,r){function o(d){if(d)return r(d);if(f.length()>=n)return r(null,f.getBytes(n));if(s.generated>1048575&&(s.key=null),null===s.key)return e.util.nextTick(function(){t(o)});var g=i(s.key,s.seed);s.generated+=g.length,f.putBytes(g),s.key=a(i(s.key,l(s.seed))),s.seed=u(i(s.key,s.seed)),e.util.setImmediate(o)}if(!r)return s.generateSync(n);var i=s.plugin.cipher,l=s.plugin.increment,a=s.plugin.formatKey,u=s.plugin.formatSeed,f=e.util.createBuffer();s.key=null,o()},s.generateSync=function(n){var r=s.plugin.cipher,t=s.plugin.increment,i=s.plugin.formatKey,l=s.plugin.formatSeed;s.key=null;for(var a=e.util.createBuffer();a.length()<n;){s.generated>1048575&&(s.key=null),null===s.key&&o();var u=r(s.key,s.seed);s.generated+=u.length,a.putBytes(u),s.key=i(r(s.key,t(s.seed))),s.seed=l(r(s.key,s.seed))}return a.getBytes(n)},r?(s.seedFile=function(e,n){r.randomBytes(e,function(e,r){return e?n(e):void n(null,r.toString())})},s.seedFileSync=function(e){return r.randomBytes(e).toString()}):(s.seedFile=function(e,n){try{n(null,l(e))}catch(r){n(r)}},s.seedFileSync=l),s.collect=function(e){for(var n=e.length,r=0;n>r;++r)s.pools[s.pool].update(e.substr(r,1)),s.pool=31===s.pool?0:s.pool+1},s.collectInt=function(e,n){for(var r="",t=0;n>t;t+=8)r+=String.fromCharCode(e>>t&255);s.collect(r)},s.registerWorker=function(e){if(e===self)s.seedFile=function(e,n){function r(e){var t=e.data;t.forge&&t.forge.prng&&(self.removeEventListener("message",r),n(t.forge.prng.err,t.forge.prng.bytes))}self.addEventListener("message",r),self.postMessage({forge:{prng:{needed:e}}})};else{var n=function(n){var r=n.data;r.forge&&r.forge.prng&&s.seedFile(r.forge.prng.needed,function(n,r){e.postMessage({forge:{prng:{err:n,bytes:r}}})})};e.addEventListener("message",n)}},s}}var n="prng";if("function"!=typeof define){if("object"!=typeof module||!module.exports)return"undefined"==typeof forge&&(forge={}),e(forge);var r=!0;define=function(e,n){n(require,module)}}var t,o=function(r,o){o.exports=function(o){var i=t.map(function(e){return r(e)}).concat(e);if(o=o||{},o.defined=o.defined||{},o.defined[n])return o[n];o.defined[n]=!0;for(var l=0;l<i.length;++l)i[l](o);return o[n]}},i=define;define=function(e,n){return t="string"==typeof e?n.slice(2):e.slice(2),r?(delete define,i.apply(null,Array.prototype.slice.call(arguments,0))):(define=i,define.apply(null,Array.prototype.slice.call(arguments,0)))},define(["require","module","./md","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}();