/**
 * Javascript implementation of basic RSA algorithms.
 *
 * @author Dave Longley
 *
 * Copyright (c) 2010-2014 Digital Bazaar, Inc.
 *
 * The only algorithm currently supported for PKI is RSA.
 *
 * An RSA key is often stored in ASN.1 DER format. The SubjectPublicKeyInfo
 * ASN.1 structure is composed of an algorithm of type AlgorithmIdentifier
 * and a subjectPublicKey of type bit string.
 *
 * The AlgorithmIdentifier contains an Object Identifier (OID) and parameters
 * for the algorithm, if any. In the case of RSA, there aren't any.
 *
 * SubjectPublicKeyInfo ::= SEQUENCE {
 *   algorithm AlgorithmIdentifier,
 *   subjectPublicKey BIT STRING
 * }
 *
 * AlgorithmIdentifer ::= SEQUENCE {
 *   algorithm OBJECT IDENTIFIER,
 *   parameters ANY DEFINED BY algorithm OPTIONAL
 * }
 *
 * For an RSA public key, the subjectPublicKey is:
 *
 * RSAPublicKey ::= SEQUENCE {
 *   modulus            INTEGER,    -- n
 *   publicExponent     INTEGER     -- e
 * }
 *
 * PrivateKeyInfo ::= SEQUENCE {
 *   version                   Version,
 *   privateKeyAlgorithm       PrivateKeyAlgorithmIdentifier,
 *   privateKey                PrivateKey,
 *   attributes           [0]  IMPLICIT Attributes OPTIONAL
 * }
 *
 * Version ::= INTEGER
 * PrivateKeyAlgorithmIdentifier ::= AlgorithmIdentifier
 * PrivateKey ::= OCTET STRING
 * Attributes ::= SET OF Attribute
 *
 * An RSA private key as the following structure:
 *
 * RSAPrivateKey ::= SEQUENCE {
 *   version Version,
 *   modulus INTEGER, -- n
 *   publicExponent INTEGER, -- e
 *   privateExponent INTEGER, -- d
 *   prime1 INTEGER, -- p
 *   prime2 INTEGER, -- q
 *   exponent1 INTEGER, -- d mod (p-1)
 *   exponent2 INTEGER, -- d mod (q-1)
 *   coefficient INTEGER -- (inverse of q) mod p
 * }
 *
 * Version ::= INTEGER
 *
 * The OID for the RSA key algorithm is: 1.2.840.113549.1.1.1
 */
!function(){function e(e){function t(t,r,n){var a=e.util.createBuffer(),i=Math.ceil(r.n.bitLength()/8);if(t.length>i-11){var o=new Error("Message is too long for PKCS#1 v1.5 padding.");throw o.length=t.length,o.max=i-11,o}a.putByte(0),a.putByte(n);var s,u=i-3-t.length;if(0===n||1===n){s=0===n?0:255;for(var p=0;u>p;++p)a.putByte(s)}else for(;u>0;){for(var l=0,c=e.random.getBytes(u),p=0;u>p;++p)s=c.charCodeAt(p),0===s?++l:a.putByte(s);u=l}return a.putByte(0),a.putBytes(t),a}function r(t,r,n,a){var i=Math.ceil(r.n.bitLength()/8),o=e.util.createBuffer(t),s=o.getByte(),u=o.getByte();if(0!==s||n&&0!==u&&1!==u||!n&&2!=u||n&&0===u&&"undefined"==typeof a)throw new Error("Encryption block is invalid.");var p=0;if(0===u){p=i-3-a;for(var l=0;p>l;++l)if(0!==o.getByte())throw new Error("Encryption block is invalid.")}else if(1===u)for(p=0;o.length()>1;){if(255!==o.getByte()){--o.read;break}++p}else if(2===u)for(p=0;o.length()>1;){if(0===o.getByte()){--o.read;break}++p}var c=o.getByte();if(0!==c||p!==i-3-o.length())throw new Error("Encryption block is invalid.");return o.getBytes()}function n(t,r,n){function a(){i(t.pBits,function(e,r){return e?n(e):(t.p=r,null!==t.q?s(e,t.q):void i(t.qBits,s))})}function i(t,r){e.prime.generateProbablePrime(t,p,r)}function s(e,r){if(e)return n(e);if(t.q=r,t.p.compareTo(t.q)<0){var p=t.p;t.p=t.q,t.q=p}if(0!==t.p.subtract(o.ONE).gcd(t.e).compareTo(o.ONE))return t.p=null,void a();if(0!==t.q.subtract(o.ONE).gcd(t.e).compareTo(o.ONE))return t.q=null,void i(t.qBits,s);if(t.p1=t.p.subtract(o.ONE),t.q1=t.q.subtract(o.ONE),t.phi=t.p1.multiply(t.q1),0!==t.phi.gcd(t.e).compareTo(o.ONE))return t.p=t.q=null,void a();if(t.n=t.p.multiply(t.q),t.n.bitLength()!==t.bits)return t.q=null,void i(t.qBits,s);var l=t.e.modInverse(t.phi);t.keys={privateKey:u.rsa.setPrivateKey(t.n,t.e,l,t.p,t.q,l.mod(t.p1),l.mod(t.q1),t.q.modInverse(t.p)),publicKey:u.rsa.setPublicKey(t.n,t.e)},n(null,t.keys)}"function"==typeof r&&(n=r,r={}),r=r||{};var p={algorithm:{name:r.algorithm||"PRIMEINC",options:{workers:r.workers||2,workLoad:r.workLoad||100,workerScript:r.workerScript}}};"prng"in r&&(p.prng=r.prng),a()}function a(t){var r=t.toString(16);return r[0]>="8"&&(r="00"+r),e.util.hexToBytes(r)}function i(e){return 100>=e?27:150>=e?18:200>=e?15:250>=e?12:300>=e?9:350>=e?8:400>=e?7:500>=e?6:600>=e?5:800>=e?4:1250>=e?3:2}if("undefined"==typeof o)var o=e.jsbn.BigInteger;var s=e.asn1;e.pki=e.pki||{},e.pki.rsa=e.rsa=e.rsa||{};var u=e.pki,p=[6,4,2,4,2,4,6,2],l={name:"PrivateKeyInfo",tagClass:s.Class.UNIVERSAL,type:s.Type.SEQUENCE,constructed:!0,value:[{name:"PrivateKeyInfo.version",tagClass:s.Class.UNIVERSAL,type:s.Type.INTEGER,constructed:!1,capture:"privateKeyVersion"},{name:"PrivateKeyInfo.privateKeyAlgorithm",tagClass:s.Class.UNIVERSAL,type:s.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:s.Class.UNIVERSAL,type:s.Type.OID,constructed:!1,capture:"privateKeyOid"}]},{name:"PrivateKeyInfo",tagClass:s.Class.UNIVERSAL,type:s.Type.OCTETSTRING,constructed:!1,capture:"privateKey"}]},c={name:"RSAPrivateKey",tagClass:s.Class.UNIVERSAL,type:s.Type.SEQUENCE,constructed:!0,value:[{name:"RSAPrivateKey.version",tagClass:s.Class.UNIVERSAL,type:s.Type.INTEGER,constructed:!1,capture:"privateKeyVersion"},{name:"RSAPrivateKey.modulus",tagClass:s.Class.UNIVERSAL,type:s.Type.INTEGER,constructed:!1,capture:"privateKeyModulus"},{name:"RSAPrivateKey.publicExponent",tagClass:s.Class.UNIVERSAL,type:s.Type.INTEGER,constructed:!1,capture:"privateKeyPublicExponent"},{name:"RSAPrivateKey.privateExponent",tagClass:s.Class.UNIVERSAL,type:s.Type.INTEGER,constructed:!1,capture:"privateKeyPrivateExponent"},{name:"RSAPrivateKey.prime1",tagClass:s.Class.UNIVERSAL,type:s.Type.INTEGER,constructed:!1,capture:"privateKeyPrime1"},{name:"RSAPrivateKey.prime2",tagClass:s.Class.UNIVERSAL,type:s.Type.INTEGER,constructed:!1,capture:"privateKeyPrime2"},{name:"RSAPrivateKey.exponent1",tagClass:s.Class.UNIVERSAL,type:s.Type.INTEGER,constructed:!1,capture:"privateKeyExponent1"},{name:"RSAPrivateKey.exponent2",tagClass:s.Class.UNIVERSAL,type:s.Type.INTEGER,constructed:!1,capture:"privateKeyExponent2"},{name:"RSAPrivateKey.coefficient",tagClass:s.Class.UNIVERSAL,type:s.Type.INTEGER,constructed:!1,capture:"privateKeyCoefficient"}]},y={name:"RSAPublicKey",tagClass:s.Class.UNIVERSAL,type:s.Type.SEQUENCE,constructed:!0,value:[{name:"RSAPublicKey.modulus",tagClass:s.Class.UNIVERSAL,type:s.Type.INTEGER,constructed:!1,capture:"publicKeyModulus"},{name:"RSAPublicKey.exponent",tagClass:s.Class.UNIVERSAL,type:s.Type.INTEGER,constructed:!1,capture:"publicKeyExponent"}]},E=e.pki.rsa.publicKeyValidator={name:"SubjectPublicKeyInfo",tagClass:s.Class.UNIVERSAL,type:s.Type.SEQUENCE,constructed:!0,captureAsn1:"subjectPublicKeyInfo",value:[{name:"SubjectPublicKeyInfo.AlgorithmIdentifier",tagClass:s.Class.UNIVERSAL,type:s.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:s.Class.UNIVERSAL,type:s.Type.OID,constructed:!1,capture:"publicKeyOid"}]},{name:"SubjectPublicKeyInfo.subjectPublicKey",tagClass:s.Class.UNIVERSAL,type:s.Type.BITSTRING,constructed:!1,value:[{name:"SubjectPublicKeyInfo.subjectPublicKey.RSAPublicKey",tagClass:s.Class.UNIVERSAL,type:s.Type.SEQUENCE,constructed:!0,optional:!0,captureAsn1:"rsaPublicKey"}]}]},f=function(e){var t;if(!(e.algorithm in u.oids)){var r=new Error("Unknown message digest algorithm.");throw r.algorithm=e.algorithm,r}t=u.oids[e.algorithm];var n=s.oidToDer(t).getBytes(),a=s.create(s.Class.UNIVERSAL,s.Type.SEQUENCE,!0,[]),i=s.create(s.Class.UNIVERSAL,s.Type.SEQUENCE,!0,[]);i.value.push(s.create(s.Class.UNIVERSAL,s.Type.OID,!1,n)),i.value.push(s.create(s.Class.UNIVERSAL,s.Type.NULL,!1,""));var o=s.create(s.Class.UNIVERSAL,s.Type.OCTETSTRING,!1,e.digest().getBytes());return a.value.push(i),a.value.push(o),s.toDer(a).getBytes()},d=function(t,r,n){if(n)return t.modPow(r.e,r.n);if(!r.p||!r.q)return t.modPow(r.d,r.n);r.dP||(r.dP=r.d.mod(r.p.subtract(o.ONE))),r.dQ||(r.dQ=r.d.mod(r.q.subtract(o.ONE))),r.qInv||(r.qInv=r.q.modInverse(r.p));var a;do a=new o(e.util.bytesToHex(e.random.getBytes(r.n.bitLength()/8)),16);while(a.compareTo(r.n)>=0||!a.gcd(r.n).equals(o.ONE));t=t.multiply(a.modPow(r.e,r.n)).mod(r.n);for(var i=t.mod(r.p).modPow(r.dP,r.p),s=t.mod(r.q).modPow(r.dQ,r.q);i.compareTo(s)<0;)i=i.add(r.p);var u=i.subtract(s).multiply(r.qInv).mod(r.p).multiply(r.q).add(s);return u=u.multiply(a.modInverse(r.n)).mod(r.n)};u.rsa.encrypt=function(r,n,a){var i,s=a,u=Math.ceil(n.n.bitLength()/8);a!==!1&&a!==!0?(s=2===a,i=t(r,n,a)):(i=e.util.createBuffer(),i.putBytes(r));for(var p=new o(i.toHex(),16),l=d(p,n,s),c=l.toString(16),y=e.util.createBuffer(),E=u-Math.ceil(c.length/2);E>0;)y.putByte(0),--E;return y.putBytes(e.util.hexToBytes(c)),y.getBytes()},u.rsa.decrypt=function(t,n,a,i){var s=Math.ceil(n.n.bitLength()/8);if(t.length!==s){var u=new Error("Encrypted message length is invalid.");throw u.length=t.length,u.expected=s,u}var p=new o(e.util.createBuffer(t).toHex(),16);if(p.compareTo(n.n)>=0)throw new Error("Encrypted message is invalid.");for(var l=d(p,n,a),c=l.toString(16),y=e.util.createBuffer(),E=s-Math.ceil(c.length/2);E>0;)y.putByte(0),--E;return y.putBytes(e.util.hexToBytes(c)),i!==!1?r(y.getBytes(),n,a):y.getBytes()},u.rsa.createKeyPairGenerationState=function(t,r,n){"string"==typeof t&&(t=parseInt(t,10)),t=t||2048,n=n||{};var a,i=n.prng||e.random,s={nextBytes:function(e){for(var t=i.getBytesSync(e.length),r=0;r<e.length;++r)e[r]=t.charCodeAt(r)}},u=n.algorithm||"PRIMEINC";if("PRIMEINC"!==u)throw new Error("Invalid key generation algorithm: "+u);return a={algorithm:u,state:0,bits:t,rng:s,eInt:r||65537,e:new o(null),p:null,q:null,qBits:t>>1,pBits:t-(t>>1),pqState:0,num:null,keys:null},a.e.fromInt(a.eInt),a},u.rsa.stepKeyPairGenerationState=function(e,t){"algorithm"in e||(e.algorithm="PRIMEINC");var r=new o(null);r.fromInt(30);for(var n,a=0,s=function(e,t){return e|t},l=+new Date,c=0;null===e.keys&&(0>=t||t>c);){if(0===e.state){var y=null===e.p?e.pBits:e.qBits,E=y-1;0===e.pqState?(e.num=new o(y,e.rng),e.num.testBit(E)||e.num.bitwiseTo(o.ONE.shiftLeft(E),s,e.num),e.num.dAddOffset(31-e.num.mod(r).byteValue(),0),a=0,++e.pqState):1===e.pqState?e.num.bitLength()>y?e.pqState=0:e.num.isProbablePrime(i(e.num.bitLength()))?++e.pqState:e.num.dAddOffset(p[a++%8],0):2===e.pqState?e.pqState=0===e.num.subtract(o.ONE).gcd(e.e).compareTo(o.ONE)?3:0:3===e.pqState&&(e.pqState=0,null===e.p?e.p=e.num:e.q=e.num,null!==e.p&&null!==e.q&&++e.state,e.num=null)}else if(1===e.state)e.p.compareTo(e.q)<0&&(e.num=e.p,e.p=e.q,e.q=e.num),++e.state;else if(2===e.state)e.p1=e.p.subtract(o.ONE),e.q1=e.q.subtract(o.ONE),e.phi=e.p1.multiply(e.q1),++e.state;else if(3===e.state)0===e.phi.gcd(e.e).compareTo(o.ONE)?++e.state:(e.p=null,e.q=null,e.state=0);else if(4===e.state)e.n=e.p.multiply(e.q),e.n.bitLength()===e.bits?++e.state:(e.q=null,e.state=0);else if(5===e.state){var f=e.e.modInverse(e.phi);e.keys={privateKey:u.rsa.setPrivateKey(e.n,e.e,f,e.p,e.q,f.mod(e.p1),f.mod(e.q1),e.q.modInverse(e.p)),publicKey:u.rsa.setPublicKey(e.n,e.e)}}n=+new Date,c+=n-l,l=n}return null!==e.keys},u.rsa.generateKeyPair=function(e,t,r,a){1===arguments.length?"object"==typeof e?(r=e,e=void 0):"function"==typeof e&&(a=e,e=void 0):2===arguments.length?"number"==typeof e?"function"==typeof t?(a=t,t=void 0):"number"!=typeof t&&(r=t,t=void 0):(r=e,a=t,e=void 0,t=void 0):3===arguments.length&&("number"==typeof t?"function"==typeof r&&(a=r,r=void 0):(a=r,r=t,t=void 0)),r=r||{},void 0===e&&(e=r.bits||2048),void 0===t&&(t=r.e||65537);var i=u.rsa.createKeyPairGenerationState(e,t,r);return a?void n(i,r,a):(u.rsa.stepKeyPairGenerationState(i,0),i.keys)},u.setRsaPublicKey=u.rsa.setPublicKey=function(n,a){var i={n:n,e:a};return i.encrypt=function(r,n,a){if("string"==typeof n?n=n.toUpperCase():void 0===n&&(n="RSAES-PKCS1-V1_5"),"RSAES-PKCS1-V1_5"===n)n={encode:function(e,r){return t(e,r,2).getBytes()}};else if("RSA-OAEP"===n||"RSAES-OAEP"===n)n={encode:function(t,r){return e.pkcs1.encode_rsa_oaep(r,t,a)}};else if("RSAES-OAEP-OLD"===n)n={encode:function(t,r){return e.pkcs1.encode_rsa_oaep_old(r,t,a)}};else if(-1!==["RAW","NONE","NULL",null].indexOf(n))n={encode:function(e){return e}};else if("string"==typeof n)throw new Error('Unsupported encryption scheme: "'+n+'".');var o=n.encode(r,i,!0);return u.rsa.encrypt(o,i,!0)},i.verify=function(e,t,n){"string"==typeof n?n=n.toUpperCase():void 0===n&&(n="RSASSA-PKCS1-V1_5"),"RSASSA-PKCS1-V1_5"===n?n={verify:function(e,t){t=r(t,i,!0);var n=s.fromDer(t);return e===n.value[1].value}}:("NONE"===n||"NULL"===n||null===n)&&(n={verify:function(e,t){return t=r(t,i,!0),e===t}});var a=u.rsa.decrypt(t,i,!0,!1);return n.verify(e,a,i.n.bitLength())},i},u.setRsaPrivateKey=u.rsa.setPrivateKey=function(t,n,a,i,o,s,p,l){var c={n:t,e:n,d:a,p:i,q:o,dP:s,dQ:p,qInv:l};return c.decrypt=function(t,n,a){"string"==typeof n?n=n.toUpperCase():void 0===n&&(n="RSAES-PKCS1-V1_5");var i=u.rsa.decrypt(t,c,!1,!1);if("RSAES-PKCS1-V1_5"===n)n={decode:r};else if("RSA-OAEP"===n||"RSAES-OAEP"===n)n={decode:function(t,r){return e.pkcs1.decode_rsa_oaep(r,t,a)}};else{if(-1===["RAW","NONE","NULL",null].indexOf(n))throw new Error('Unsupported encryption scheme: "'+n+'".');n={decode:function(e){return e}}}return n.decode(i,c,!1)},c.sign=function(e,t){var r=!1;"string"==typeof t&&(t=t.toUpperCase()),void 0===t||"RSASSA-PKCS1-V1_5"===t?(t={encode:f},r=1):("NONE"===t||"NULL"===t||null===t)&&(t={encode:function(){return e}},r=1);var n=t.encode(e,c.n.bitLength());return u.rsa.encrypt(n,c,r)},c},u.wrapRsaPrivateKey=function(e){return s.create(s.Class.UNIVERSAL,s.Type.SEQUENCE,!0,[s.create(s.Class.UNIVERSAL,s.Type.INTEGER,!1,s.integerToDer(0).getBytes()),s.create(s.Class.UNIVERSAL,s.Type.SEQUENCE,!0,[s.create(s.Class.UNIVERSAL,s.Type.OID,!1,s.oidToDer(u.oids.rsaEncryption).getBytes()),s.create(s.Class.UNIVERSAL,s.Type.NULL,!1,"")]),s.create(s.Class.UNIVERSAL,s.Type.OCTETSTRING,!1,s.toDer(e).getBytes())])},u.privateKeyFromAsn1=function(t){var r={},n=[];if(s.validate(t,l,r,n)&&(t=s.fromDer(e.util.createBuffer(r.privateKey))),r={},n=[],!s.validate(t,c,r,n)){var a=new Error("Cannot read private key. ASN.1 object does not contain an RSAPrivateKey.");throw a.errors=n,a}var i,p,y,E,f,d,v,S;return i=e.util.createBuffer(r.privateKeyModulus).toHex(),p=e.util.createBuffer(r.privateKeyPublicExponent).toHex(),y=e.util.createBuffer(r.privateKeyPrivateExponent).toHex(),E=e.util.createBuffer(r.privateKeyPrime1).toHex(),f=e.util.createBuffer(r.privateKeyPrime2).toHex(),d=e.util.createBuffer(r.privateKeyExponent1).toHex(),v=e.util.createBuffer(r.privateKeyExponent2).toHex(),S=e.util.createBuffer(r.privateKeyCoefficient).toHex(),u.setRsaPrivateKey(new o(i,16),new o(p,16),new o(y,16),new o(E,16),new o(f,16),new o(d,16),new o(v,16),new o(S,16))},u.privateKeyToAsn1=u.privateKeyToRSAPrivateKey=function(e){return s.create(s.Class.UNIVERSAL,s.Type.SEQUENCE,!0,[s.create(s.Class.UNIVERSAL,s.Type.INTEGER,!1,s.integerToDer(0).getBytes()),s.create(s.Class.UNIVERSAL,s.Type.INTEGER,!1,a(e.n)),s.create(s.Class.UNIVERSAL,s.Type.INTEGER,!1,a(e.e)),s.create(s.Class.UNIVERSAL,s.Type.INTEGER,!1,a(e.d)),s.create(s.Class.UNIVERSAL,s.Type.INTEGER,!1,a(e.p)),s.create(s.Class.UNIVERSAL,s.Type.INTEGER,!1,a(e.q)),s.create(s.Class.UNIVERSAL,s.Type.INTEGER,!1,a(e.dP)),s.create(s.Class.UNIVERSAL,s.Type.INTEGER,!1,a(e.dQ)),s.create(s.Class.UNIVERSAL,s.Type.INTEGER,!1,a(e.qInv))])},u.publicKeyFromAsn1=function(t){var r={},n=[];if(s.validate(t,E,r,n)){var a=s.derToOid(r.publicKeyOid);if(a!==u.oids.rsaEncryption){var i=new Error("Cannot read public key. Unknown OID.");throw i.oid=a,i}t=r.rsaPublicKey}if(n=[],!s.validate(t,y,r,n)){var i=new Error("Cannot read public key. ASN.1 object does not contain an RSAPublicKey.");throw i.errors=n,i}var p=e.util.createBuffer(r.publicKeyModulus).toHex(),l=e.util.createBuffer(r.publicKeyExponent).toHex();return u.setRsaPublicKey(new o(p,16),new o(l,16))},u.publicKeyToAsn1=u.publicKeyToSubjectPublicKeyInfo=function(e){return s.create(s.Class.UNIVERSAL,s.Type.SEQUENCE,!0,[s.create(s.Class.UNIVERSAL,s.Type.SEQUENCE,!0,[s.create(s.Class.UNIVERSAL,s.Type.OID,!1,s.oidToDer(u.oids.rsaEncryption).getBytes()),s.create(s.Class.UNIVERSAL,s.Type.NULL,!1,"")]),s.create(s.Class.UNIVERSAL,s.Type.BITSTRING,!1,[u.publicKeyToRSAPublicKey(e)])])},u.publicKeyToRSAPublicKey=function(e){return s.create(s.Class.UNIVERSAL,s.Type.SEQUENCE,!0,[s.create(s.Class.UNIVERSAL,s.Type.INTEGER,!1,a(e.n)),s.create(s.Class.UNIVERSAL,s.Type.INTEGER,!1,a(e.e))])}}var t="rsa";if("function"!=typeof define){if("object"!=typeof module||!module.exports)return"undefined"==typeof forge&&(forge={}),e(forge);var r=!0;define=function(e,t){t(require,module)}}var n,a=function(r,a){a.exports=function(a){var i=n.map(function(e){return r(e)}).concat(e);if(a=a||{},a.defined=a.defined||{},a.defined[t])return a[t];a.defined[t]=!0;for(var o=0;o<i.length;++o)i[o](a);return a[t]}},i=define;define=function(e,t){return n="string"==typeof e?t.slice(2):e.slice(2),r?(delete define,i.apply(null,Array.prototype.slice.call(arguments,0))):(define=i,define.apply(null,Array.prototype.slice.call(arguments,0)))},define(["require","module","./asn1","./jsbn","./oids","./pkcs1","./prime","./random","./util"],function(){a.apply(null,Array.prototype.slice.call(arguments,0))})}();