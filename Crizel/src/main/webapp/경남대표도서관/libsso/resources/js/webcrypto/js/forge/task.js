/**
 * Support for concurrent task management and synchronization in web
 * applications.
 *
 * @author Dave Longley
 * @author David I. Lehn <dlehn@digitalbazaar.com>
 *
 * Copyright (c) 2009-2013 Digital Bazaar, Inc.
 */
!function(){function t(t){var e="forge.task",s=0,i={},n=0;t.debug.set(e,"tasks",i);var a={};t.debug.set(e,"queues",a);var r="?",u=30,o=20,l="ready",p="running",c="blocked",f="sleeping",h="done",d="error",k="stop",y="start",m="block",b="unblock",g="sleep",v="wakeup",w="cancel",T="fail",C={};C[l]={},C[l][k]=l,C[l][y]=p,C[l][w]=h,C[l][T]=d,C[p]={},C[p][k]=l,C[p][y]=p,C[p][m]=c,C[p][b]=p,C[p][g]=f,C[p][v]=p,C[p][w]=h,C[p][T]=d,C[c]={},C[c][k]=c,C[c][y]=c,C[c][m]=c,C[c][b]=c,C[c][g]=c,C[c][v]=c,C[c][w]=h,C[c][T]=d,C[f]={},C[f][k]=f,C[f][y]=f,C[f][m]=f,C[f][b]=f,C[f][g]=f,C[f][v]=f,C[f][w]=h,C[f][T]=d,C[h]={},C[h][k]=h,C[h][y]=h,C[h][m]=h,C[h][b]=h,C[h][g]=h,C[h][v]=h,C[h][w]=h,C[h][T]=d,C[d]={},C[d][k]=d,C[d][y]=d,C[d][m]=d,C[d][b]=d,C[d][g]=d,C[d][v]=d,C[d][w]=d,C[d][T]=d;var D=function(a){this.id=-1,this.name=a.name||r,this.parent=a.parent||null,this.run=a.run,this.subtasks=[],this.error=!1,this.state=l,this.blocks=0,this.timeoutId=null,this.swapTime=null,this.userData=null,this.id=n++,i[this.id]=this,s>=1&&t.log.verbose(e,"[%s][%s] init",this.id,this.name,this)};D.prototype.debug=function(s){s=s||"",t.log.debug(e,s,"[%s][%s] task:",this.id,this.name,this,"subtasks:",this.subtasks.length,"queue:",a)},D.prototype.next=function(t,e){"function"==typeof t&&(e=t,t=this.name);var s=new D({run:e,name:t,parent:this});return s.state=p,s.type=this.type,s.successCallback=this.successCallback||null,s.failureCallback=this.failureCallback||null,this.subtasks.push(s),this},D.prototype.parallel=function(e,s){return t.util.isArray(e)&&(s=e,e=this.name),this.next(e,function(i){var n=i;n.block(s.length);for(var a=function(e,i){t.task.start({type:e,run:function(t){s[i](t)},success:function(){n.unblock()},failure:function(){n.unblock()}})},r=0;r<s.length;r++){var u=e+"__parallel-"+i.id+"-"+r,o=r;a(u,o)}})},D.prototype.stop=function(){this.state=C[this.state][k]},D.prototype.start=function(){this.error=!1,this.state=C[this.state][y],this.state===p&&(this.start=new Date,this.run(this),I(this,0))},D.prototype.block=function(t){t="undefined"==typeof t?1:t,this.blocks+=t,this.blocks>0&&(this.state=C[this.state][m])},D.prototype.unblock=function(t){return t="undefined"==typeof t?1:t,this.blocks-=t,0===this.blocks&&this.state!==h&&(this.state=p,I(this,0)),this.blocks},D.prototype.sleep=function(t){t="undefined"==typeof t?0:t,this.state=C[this.state][g];var e=this;this.timeoutId=setTimeout(function(){e.timeoutId=null,e.state=p,I(e,0)},t)},D.prototype.wait=function(t){t.wait(this)},D.prototype.wakeup=function(){this.state===f&&(cancelTimeout(this.timeoutId),this.timeoutId=null,this.state=p,I(this,0))},D.prototype.cancel=function(){this.state=C[this.state][w],this.permitsNeeded=0,null!==this.timeoutId&&(cancelTimeout(this.timeoutId),this.timeoutId=null),this.subtasks=[]},D.prototype.fail=function(t){if(this.error=!0,x(this,!0),t)t.error=this.error,t.swapTime=this.swapTime,t.userData=this.userData,I(t,0);else{if(null!==this.parent){for(var e=this.parent;null!==e.parent;)e.error=this.error,e.swapTime=this.swapTime,e.userData=this.userData,e=e.parent;x(e,!0)}this.failureCallback&&this.failureCallback(this)}};var q=function(t){t.error=!1,t.state=C[t.state][y],setTimeout(function(){t.state===p&&(t.swapTime=+new Date,t.run(t),I(t,0))},0)},I=function(t,e){var s=e>u||+new Date-t.swapTime>o,i=function(e){if(e++,t.state===p)if(s&&(t.swapTime=+new Date),t.subtasks.length>0){var i=t.subtasks.shift();i.error=t.error,i.swapTime=t.swapTime,i.userData=t.userData,i.run(i),i.error||I(i,e)}else x(t),t.error||null!==t.parent&&(t.parent.error=t.error,t.parent.swapTime=t.swapTime,t.parent.userData=t.userData,I(t.parent,e))};s?setTimeout(i,0):i(e)},x=function(n,r){n.state=h,delete i[n.id],s>=1&&t.log.verbose(e,"[%s][%s] finish",n.id,n.name,n),null===n.parent&&(n.type in a?0===a[n.type].length?t.log.error(e,"[%s][%s] task queue empty [%s]",n.id,n.name,n.type):a[n.type][0]!==n?t.log.error(e,"[%s][%s] task not first in queue [%s]",n.id,n.name,n.type):(a[n.type].shift(),0===a[n.type].length?(s>=1&&t.log.verbose(e,"[%s][%s] delete queue [%s]",n.id,n.name,n.type),delete a[n.type]):(s>=1&&t.log.verbose(e,"[%s][%s] queue start next [%s] remain:%s",n.id,n.name,n.type,a[n.type].length),a[n.type][0].start())):t.log.error(e,"[%s][%s] task queue missing [%s]",n.id,n.name,n.type),r||(n.error&&n.failureCallback?n.failureCallback(n):!n.error&&n.successCallback&&n.successCallback(n)))};t.task=t.task||{},t.task.start=function(i){var n=new D({run:i.run,name:i.name||r});n.type=i.type,n.successCallback=i.success||null,n.failureCallback=i.failure||null,n.type in a?a[i.type].push(n):(s>=1&&t.log.verbose(e,"[%s][%s] create queue [%s]",n.id,n.name,n.type),a[n.type]=[n],q(n))},t.task.cancel=function(t){t in a&&(a[t]=[a[t][0]])},t.task.createCondition=function(){var t={tasks:{}};return t.wait=function(e){e.id in t.tasks||(e.block(),t.tasks[e.id]=e)},t.notify=function(){var e=t.tasks;t.tasks={};for(var s in e)e[s].unblock()},t}}var e="task";if("function"!=typeof define){if("object"!=typeof module||!module.exports)return"undefined"==typeof forge&&(forge={}),t(forge);var s=!0;define=function(t,e){e(require,module)}}var i,n=function(s,n){n.exports=function(n){var a=i.map(function(t){return s(t)}).concat(t);if(n=n||{},n.defined=n.defined||{},n.defined[e])return n[e];n.defined[e]=!0;for(var r=0;r<a.length;++r)a[r](n);return n[e]}},a=define;define=function(t,e){return i="string"==typeof t?e.slice(2):t.slice(2),s?(delete define,a.apply(null,Array.prototype.slice.call(arguments,0))):(define=a,define.apply(null,Array.prototype.slice.call(arguments,0)))},define(["require","module","./debug","./log","./util"],function(){n.apply(null,Array.prototype.slice.call(arguments,0))})}();