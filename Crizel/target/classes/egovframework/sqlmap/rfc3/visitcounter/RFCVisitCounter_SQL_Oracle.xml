<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="RFCVisitCounterManage">
	
	<cacheModel type="${Globals.ibatis.default.cache}" id="RFCVisitCounterManageCache" readOnly="true" serialize="false">
      <flushInterval hours="24" />
      	<flushOnExecute statement="visitCounterDAO.insertVisitCounter"/>
      	<flushOnExecute statement="visitCounterDAO.insertBannerCounter"/>
     </cacheModel>
     
	<typeAlias  alias="egovMap"      type = "egovframework.rte.psl.dataaccess.util.EgovMap"/>
    <typeAlias  alias="visitCounterVO"	 type = "egovframework.rfc3.visitcounter.vo.VisitCounterVO"/>
    <typeAlias  alias="bannerCounterVO"	 type = "egovframework.rfc3.visitcounter.vo.BannerCounterVO"/>
    
    <resultMap id="counter" class="egovframework.rfc3.visitcounter.vo.VisitCounterVO">
		<result property="accessDate" column="accessDate" />
		<result property="accessCount" column="accessCount" />
	</resultMap>
	
	<resultMap id="week" class="egovframework.rfc3.visitcounter.vo.VisitCounterVO">
		<result property="dayOfWeek" column="dayOfWeek" />
		<result property="accessCount" column="accessCount" />
	</resultMap>
	
	<resultMap id="time" class="egovframework.rfc3.visitcounter.vo.VisitCounterVO">
		<result property="accessTime" column="accessTime" />
		<result property="accessCount" column="accessCount" />
	</resultMap>
	
	<resultMap id="ip" class="egovframework.rfc3.visitcounter.vo.VisitCounterVO">
		<result property="connectIp" column="connectIp" />
		<result property="accessCount" column="accessCount" />
	</resultMap>
	
	<resultMap id="browser" class="egovframework.rfc3.visitcounter.vo.VisitCounterVO">
		<result property="browser" column="browser" />
		<result property="accessCount" column="accessCount" />
	</resultMap>
	
	<resultMap id="os" class="egovframework.rfc3.visitcounter.vo.VisitCounterVO">
		<result property="connectOs" column="connectOs" />
		<result property="accessCount" column="accessCount" />
	</resultMap>
    
    <select id="visitCounterDAO.selectYearVisitCounter" parameterClass="visitCounterVO" resultMap="counter" cacheModel="RFCVisitCounterManageCache">
    				SELECT
    					SUBSTR(ACCESS_DATE,1,$dateLength$) accessDate,
    					count(*) accessCount
    				FROM
    					RFC_COMTHVISITCOUNTER
					<dynamic prepend="WHERE">
						<isNotEmpty prepend="AND" property="sgroupId" >
			          		     SGROUP_ID  = #sgroupId#
			            </isNotEmpty>
			            <isNotEmpty prepend="AND" property="domainId" >
		                       DOMAIN_ID  = #domainId#
		                </isNotEmpty> 
		                <isEmpty  property="domainId" >
		                   	<isEqual  prepend="AND"   property="isDomainAdmin" compareValue="true">
		                     	   DOMAIN_ID in ( $myDomainList$ )
		          			</isEqual>
		               </isEmpty> 	
						<isNotEmpty prepend="AND" property="accessDate" >
						   			 ACCESS_DATE LIKE '$accessDate$%'
						</isNotEmpty>	
					</dynamic> 
    				GROUP BY
    					SUBSTR(ACCESS_DATE,1,$dateLength$) 
    				ORDER BY
    					SUBSTR(ACCESS_DATE,1,$dateLength$)
    </select>
    
    <select id="visitCounterDAO.selectWeekVisitCounter" parameterClass="visitCounterVO" resultMap="week" cacheModel="RFCVisitCounterManageCache">
    				SELECT
    					DAY_OF_WEEK dayOfWeek,
    					count(*) accessCount
    				FROM
    					RFC_COMTHVISITCOUNTER
					<dynamic prepend="WHERE">
						<isNotEmpty prepend="AND" property="sgroupId" >
			          		     SGROUP_ID  = #sgroupId#
			            </isNotEmpty>
			            <isNotEmpty prepend="AND" property="domainId" >
		                       DOMAIN_ID  = #domainId#
		                </isNotEmpty> 
		                <isEmpty  property="domainId" >
		                   	<isEqual  prepend="AND"   property="isDomainAdmin" compareValue="true">
		                     	   DOMAIN_ID in ( $myDomainList$ )
		          			</isEqual>
		               </isEmpty> 	
						<isNotEmpty prepend="AND" property="startDate" >
						   			 ACCESS_DATE >= #startDate#
						</isNotEmpty>	
						<isNotEmpty prepend="AND" property="endDate" >
						   			 #endDate# >= ACCESS_DATE
						</isNotEmpty>
					</dynamic> 
    				GROUP BY
    					DAY_OF_WEEK
    				ORDER BY
    					DAY_OF_WEEK ASC
    </select>
    
    <select id="visitCounterDAO.selectTimeVisitCounter" parameterClass="visitCounterVO" resultMap="time" cacheModel="RFCVisitCounterManageCache">
    				SELECT
    					SUBSTR(ACCESS_TIME,1,2) accessTime,
    					count(*) accessCount
    				FROM
    					RFC_COMTHVISITCOUNTER
					<dynamic prepend="WHERE">
						<isNotEmpty prepend="AND" property="sgroupId" >
			          		     SGROUP_ID  = #sgroupId#
			            </isNotEmpty>
			            <isNotEmpty prepend="AND" property="domainId" >
		                       DOMAIN_ID  = #domainId#
		                </isNotEmpty> 
		                <isEmpty  property="domainId" >
		                   	<isEqual  prepend="AND"   property="isDomainAdmin" compareValue="true">
		                     	   DOMAIN_ID in ( $myDomainList$ )
		          			</isEqual>
		               </isEmpty> 	
						<isNotEmpty prepend="AND" property="startDate" >
						   			 ACCESS_DATE >= #startDate#
						</isNotEmpty>	
						<isNotEmpty prepend="AND" property="endDate" >
						   			 #endDate# >= ACCESS_DATE
						</isNotEmpty>
					</dynamic> 
    				GROUP BY
    					SUBSTR(ACCESS_TIME,1,2)
    				ORDER BY
    					SUBSTR(ACCESS_TIME,1,2) ASC
    </select>
    
    <select id="visitCounterDAO.selectIpVisitCounterTotal" parameterClass="visitCounterVO" resultClass="int" cacheModel="RFCVisitCounterManageCache">
    				SELECT
    					count( DISTINCT(CONNECT_IP) )  totcnt    					
    				FROM
    					RFC_COMTHVISITCOUNTER
					<dynamic prepend="WHERE">
						<isNotEmpty prepend="AND" property="sgroupId" >
			          		     SGROUP_ID  = #sgroupId#
			            </isNotEmpty>
			            <isNotEmpty prepend="AND" property="domainId" >
		                       DOMAIN_ID  = #domainId#
		                </isNotEmpty> 
		                <isEmpty  property="domainId" >
		                   	<isEqual  prepend="AND"   property="isDomainAdmin" compareValue="true">
		                     	   DOMAIN_ID in ( $myDomainList$ )
		          			</isEqual>
		               </isEmpty> 	
						<isNotEmpty prepend="AND" property="startDate" >
						   			 ACCESS_DATE >= #startDate#
						</isNotEmpty>	
						<isNotEmpty prepend="AND" property="endDate" >
						   			 #endDate# >= ACCESS_DATE
						</isNotEmpty>
					</dynamic>
    				ORDER BY
    					ACCESS_DATE DESC
    </select>
    
    <select id="visitCounterDAO.selectIpVisitCounter" parameterClass="visitCounterVO" resultMap="ip" cacheModel="RFCVisitCounterManageCache">
			SELECT  * 
			FROM (
				SELECT ROWNUM RNUM, ALL_LIST.*  
				FROM  
				(
    				SELECT
    					CONNECT_IP connectIp,
    					count(*) accessCount
    				FROM
    					RFC_COMTHVISITCOUNTER
					<dynamic prepend="WHERE">
						<isNotEmpty prepend="AND" property="sgroupId" >
			          		     SGROUP_ID  = #sgroupId#
			            </isNotEmpty>
			            <isNotEmpty prepend="AND" property="domainId" >
		                       DOMAIN_ID  = #domainId#
		                </isNotEmpty> 
		                <isEmpty  property="domainId" >
		                   	<isEqual  prepend="AND"   property="isDomainAdmin" compareValue="true">
		                     	   DOMAIN_ID in ( $myDomainList$ )
		          			</isEqual>
		               </isEmpty> 	
						<isNotEmpty prepend="AND" property="startDate" >
						   			 ACCESS_DATE >= #startDate#
						</isNotEmpty>	
						<isNotEmpty prepend="AND" property="endDate" >
						   			 #endDate# >= ACCESS_DATE
						</isNotEmpty>
					</dynamic> 
    				GROUP BY
    					CONNECT_IP
    				ORDER BY
    					CONNECT_IP DESC    					
    			) ALL_LIST
	      )
		  WHERE  RNUM  &gt; #firstIndex#
		  AND  RNUM &lt;= #firstIndex# + #recordCountPerPage#
    </select>
    
    <select id="visitCounterDAO.selectBrowserVisitCounter" parameterClass="visitCounterVO" resultMap="browser" cacheModel="RFCVisitCounterManageCache">
    				SELECT
    					BROWSER browser,
    					count(*) accessCount
    				FROM
    					RFC_COMTHVISITCOUNTER
					<dynamic prepend="WHERE">
						<isNotEmpty prepend="AND" property="sgroupId" >
			          		     SGROUP_ID  = #sgroupId#
			            </isNotEmpty>
			            <isNotEmpty prepend="AND" property="domainId" >
		                       DOMAIN_ID  = #domainId#
		                </isNotEmpty> 
		                <isEmpty  property="domainId" >
		                   	<isEqual  prepend="AND"   property="isDomainAdmin" compareValue="true">
		                     	   DOMAIN_ID in ( $myDomainList$ )
		          			</isEqual>
		               </isEmpty> 	
						<isNotEmpty prepend="AND" property="startDate" >
						   			 ACCESS_DATE >= #startDate#
						</isNotEmpty>	
						<isNotEmpty prepend="AND" property="endDate" >
						   			 #endDate# >= ACCESS_DATE
						</isNotEmpty>
					</dynamic> 
    				GROUP BY
    					BROWSER
    				ORDER BY
    					BROWSER DESC
    </select>
    <select id="visitCounterDAO.selectOsVisitCounter" parameterClass="visitCounterVO" resultMap="os" cacheModel="RFCVisitCounterManageCache">
    				SELECT
    					CONNECT_OS connectOs,
    					count(*) accessCount
    				FROM
    					RFC_COMTHVISITCOUNTER
					<dynamic prepend="WHERE">
						<isNotEmpty prepend="AND" property="sgroupId" >
			          		     SGROUP_ID  = #sgroupId#
			            </isNotEmpty>
			            <isNotEmpty prepend="AND" property="domainId" >
		                       DOMAIN_ID  = #domainId#
		                </isNotEmpty> 
		                <isEmpty  property="domainId" >
		                   	<isEqual  prepend="AND"   property="isDomainAdmin" compareValue="true">
		                     	   DOMAIN_ID in ( $myDomainList$ )
		          			</isEqual>
		               </isEmpty> 	
						<isNotEmpty prepend="AND" property="startDate" >
						   			 ACCESS_DATE >= #startDate#
						</isNotEmpty>	
						<isNotEmpty prepend="AND" property="endDate" >
						   			 #endDate# >= ACCESS_DATE
						</isNotEmpty>
					</dynamic> 
    				GROUP BY
    					CONNECT_OS
    				ORDER BY
    					CONNECT_OS DESC
    </select>
    
    <select id="visitCounterDAO.visitCounter" parameterClass="visitCounterVO" resultClass="int" cacheModel="RFCVisitCounterManageCache">
    				SELECT    					
    					count(*) totcnt
    				FROM
    					RFC_COMTHVISITCOUNTER
					<dynamic prepend="WHERE">
						<isNotEmpty prepend="AND" property="sgroupId" >
			          		     SGROUP_ID  = #sgroupId#
			            </isNotEmpty>
			            <isNotEmpty prepend="AND" property="domainId" >
		                       DOMAIN_ID  = #domainId#
		                </isNotEmpty> 
		                <isEmpty  property="domainId" >
		                   	<isEqual  prepend="AND"   property="isDomainAdmin" compareValue="true">
		                     	   DOMAIN_ID in ( $myDomainList$ )
		          			</isEqual>
		               </isEmpty> 	
						<isNotEmpty prepend="AND" property="accessDate" >
						   			 ACCESS_DATE like '$accessDate$%'
						</isNotEmpty>	
					</dynamic>
    </select>
    
    <insert id="visitCounterDAO.insertVisitCounter" parameterClass="visitCounterVO"  >
			       	INSERT INTO RFC_COMTHVISITCOUNTER
			       	(
			       		COUNTER_SID,
						SGROUP_ID,
						DOMAIN_ID,
						ACCESS_DATE,
						ACCESS_TIME,
						CONNECT_IP,
						REFERER,
						BROWSER,
						CONNECT_OS,
						DAY_OF_WEEK   
			       	)
			       	VALUES
			       	(
			       		#counterSid#,
						#sgroupId#,
						#domainId#,
						#accessDate#,
						#accessTime#,
						#connectIp#,
						#referer#,
						#browser#,
						#connectOs#,
						#dayOfWeek#	
			       	)			       	
	</insert>
	<insert id="visitCounterDAO.insertBannerCounter" parameterClass="bannerCounterVO"  >
			       	INSERT INTO RFC_COMTHBANNERCOUNTER
			       	(
			       		BANNER_COUNT_SID,
						BANNER_TYPE,
						POPUP_SID,
						BANNER_TITLE,
						BANNER_URL,
						USER_NAME,
						USER_ID,
						CONNECT_IP,
						ACCESS_DATE,
						ACCESS_TIME
			       	)
			       	VALUES
			       	(
			       		#bannerCountSid#,
						#bannerType#,
						#popupSid#,
						#bannerTitle#,
						#bannerUrl#,
						#userName#,
						#userId#,
						#connectIp#,
						#accessDate#,
						#accessTime#
			       	)			       	
	</insert>
	<select id="visitCounterDAO.selectBannerCounterList" parameterClass="bannerCounterVO" resultClass="bannerCounterVO" cacheModel="RFCVisitCounterManageCache">
    				SELECT POPUP.SGROUP_ID, 
				       POPUP.DOMAIN_ID,
				       POPUP.POPUP_TITLE, 
				       POPUP.POPUP_URL, 
				       CNT.CNT 
				  FROM RFC_COMTNPOPUP POPUP 
				     INNER JOIN 
				       (SELECT BANNER_TYPE, 
				              POPUP_SID, 
				              COUNT(POPUP_SID) CNT 
				         FROM RFC_COMTHBANNERCOUNTER 
				        WHERE ACCESS_DATE BETWEEN '20131101' AND '20131104' 
				          GROUP BY BANNER_TYPE, 
				              POPUP_SID 
				       ) CNT 
				         ON POPUP.POPUP_SID = CNT.POPUP_SID
    </select>
</sqlMap>