<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="RFCBuyManage">
	<cacheModel type="${Globals.ibatis.default.cache}" id="RFCBuyManageCache" readOnly="true" serialize="false">
      <flushInterval hours="24" />
      	<flushOnExecute statement="buyDAO.insertBuyInfo"/>
      	<flushOnExecute statement="buyDAO.updateBuyInfo"/>
      	<flushOnExecute statement="buyDAO.insertBuyGoods"/>
      	<flushOnExecute statement="buyDAO.insertBuyGoodsDetail"/>
      	<flushOnExecute statement="buyDAO.deleteBuyInfo"/>
      	<flushOnExecute statement="buyDAO.deleteBuyGodsDetail"/>
      	<flushOnExecute statement="buyDAO.updateMallUserInfo"/>
      	<flushOnExecute statement="buyDAO.deleteBuyGoodsDetail"/>
      	<flushOnExecute statement="buyDAO.updateBuyGoodsDetail"/>
      	<flushOnExecute statement="buyDAO.updateDetailStatus"/>
    </cacheModel>
    <typeAlias  alias="goodsVO" type = "egovframework.rfc3.mall.vo.GoodsVO"/>
	<typeAlias  alias="buyInfoVO" type = "egovframework.rfc3.mall.vo.BuyInfoVO"/>
	<typeAlias  alias="buyHistoryVO" type = "egovframework.rfc3.mall.vo.BuyHistoryVO"/>
	<typeAlias  alias="buyGoodsVO" type = "egovframework.rfc3.mall.vo.BuyGoodsVO"/>
	<typeAlias  alias="buyGoodsDetailVO" type = "egovframework.rfc3.mall.vo.BuyGoodsDetailVO"/>
	
	<typeAlias  alias="MberManageVO" type = "egovframework.rfc3.user.vo.MberManageVO"/>
	
	<delete id="buyDAO.deleteBuyInfo"  parameterClass="buyInfoVO">
		DELETE RFC_COMTNBUYINFO WHERE BUY_CODE = #buyCode#
	</delete>
	<delete id="buyDAO.deleteBuyGodsDetail"  parameterClass="buyInfoVO">
		DELETE RFC_COMTNBUYGOODSDETAIL WHERE BUY_CODE = #buyCode#
	</delete>
	<insert id="buyDAO.insertBuyInfo"  parameterClass="buyInfoVO">
		INSERT INTO RFC_COMTNBUYINFO
		(
			BUY_CODE,
			MBER_ID,
			BUY_STATUS,
			BUY_TOTAL_PRICE,
			BILL_TYPE,
			BILL_APPROVAL,
			BILL_BANK,
			BILL_ACCOUNT,
			BILL_PAYNAME,
			MULTI_DELIVERY,
			DELIVERY_MEMO,
			RECEIVE_NAME,
			RECEIVE_ADDRESS,
			RECEIVE_DETAIL_ADDRESS,
			RECEIVE_ZIPCODE,
			RECEIVE_TEL,
			RECEIVE_CEL,
			FIXED_DATE,
			RECOMMAND_NAME,
			RECOMMAND_TEL,
			RECOMMAND_WORK,
			RECOMMAND_PART,
			BUY_MODIFY_DATE,
			BUY_REGISTER_DATE
		)
		VALUES
		(
			#buyCode#,
			#mberId#,
			#buyStatus#,
			#buyTotalPrice#,
			#billType#,
			#billApproval#,
			#billBank#,
			#billAccount#,
			#billPayName#,
			#multiDelivery#,
			#deliveryMemo#,
			#receiveName#,
			#receiveAddress#,
			SCP.ENC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,#receiveDetailAddress#),
			#receiveZipcode#,
			SCP.ENC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,#receiveTel#),
			SCP.ENC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,#receiveCel#),
			#fixed_dt#,
			#recommandName#,
			#recommandTel#,
			#recommandWork#,
			#recommandPart#,
			#modify_dt#,
			#register_dt#
		)
	</insert>
	
	<update id="buyDAO.updateBuyInfo"  parameterClass="buyInfoVO" >
		UPDATE
			RFC_COMTNBUYINFO
		SET
			BUY_STATUS = #buyStatus#,
			BILL_TYPE = #billType#,
			BILL_APPROVAL = #billApproval#,
			BILL_BANK = #billBank#,
			BILL_ACCOUNT = #billAccount#,
			BILL_PAYNAME = #billPayName#,
			BILL_PRICE = #billPrice#,
			MULTI_DELIVERY = #multiDelivery#,
			FIXED_DATE = #fixed_dt#,
			BUY_MODIFY_DATE = #modify_dt#,
			BUY_REGISTER_DATE = #register_dt#,
			RECEIVE_NAME = #receiveName#,
			RECEIVE_ADDRESS = #receiveAddress#,
			RECEIVE_DETAIL_ADDRESS = SCP.ENC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,#receiveDetailAddress#),
			RECEIVE_ZIPCODE = #receiveZipcode#,
			RECEIVE_TEL = SCP.ENC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,#receiveTel#),
			RECEIVE_CEL = SCP.ENC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,#receiveCel#),
			<isEqual property="isManager" compareValue="true">
				MANAGER_MEMO = #managerMemo#,
				NON_PAYMENT = #nonPayment#,
			</isEqual>
			DELIVERY_MEMO = #deliveryMemo#,
			RECOMMAND_NAME = #recommandName#,
			RECOMMAND_TEL = #recommandTel#,
			RECOMMAND_WORK = #recommandWork#,
			RECOMMAND_PART = #recommandPart#
		WHERE
			BUY_CODE = #buyCode#
			<isNotEmpty prepend="AND" property="mberId" >
				MBER_ID = #mberId#
			</isNotEmpty>
	</update>
	
	<select id="buyDAO.getUserBuyGoods"  parameterClass="buyGoodsVO" resultClass="buyGoodsVO" cacheModel="RFCBuyManageCache">
		SELECT
			BUY_GOODS_SID buyGoodsSid,
			BUY_CODE buyCode,
			GOODS_CODE goodsCode,
			BUY_GOODS_TYPE buyGoodsType,
			MBER_ID mberId,
			BUY_GOODS_MODIFY_DATE modify_dt
		FROM
			RFC_COMTNBUYGOODS
		WHERE
			GOODS_CODE = #goodsCode# AND BUY_GOODS_TYPE = #buyGoodsType# AND MBER_ID = #mberId#		
	</select>
	
	<select id="buyDAO.selectBuyGoodsList"  parameterClass="buyGoodsVO" resultClass="buyGoodsDetailVO" cacheModel="RFCBuyManageCache">
		SELECT
			BUYGOODS.BUY_GOODS_SID buyGoodsSid,
			BUYGOODS.BUY_CODE buyCode,
			BUYGOODS.GOODS_CODE goodsCode,
            DETAIL.DETAIL_SID detailSid,
			DETAIL.DETAIL_DEFF detailDeff,			
			DETAIL.GOODS_IS_BUNDLE goodsIsBundle,
			DETAIL.GOODS_WEIGHT goodsWeight,
			DETAIL.GOODS_PRICE goodsPrice,
			DETAIL.DELIVERY_TYPE deliveryType,
			DETAIL.DELIVERY_COMPANY deliveryCompany,
			DETAIL.DELIVERY_NUMBER deliveryNumber,
			DETAIL.DELIVERY_DATE deliveryDate,
			DETAIL.DETAIL_STATUS detailStatus,
			DETAIL.DELIVERY_MEMO deliveryMemo,
			DETAIL.GOODS_COUNT goodsCount,
			DETAIL.MNG_ID mngId,
			DETAIL.GOODS_OPTION1 goodsOption1,
			DETAIL.GOODS_OPTION_COUNT1 goodsOptionCount1,
			DETAIL.GOODS_OPTION_TEXT1 goodsOptionText1,
			DETAIL.GOODS_OPTION2 goodsOption2,
			DETAIL.GOODS_OPTION_COUNT2 goodsOptionCount2,
			DETAIL.GOODS_OPTION_TEXT2 goodsOptionText2,
			DETAIL.DETAIL_MODIFY_DATE modify_dt
		FROM
			RFC_COMTNBUYGOODS BUYGOODS LEFT OUTER JOIN RFC_COMTNBUYGOODSDETAIL DETAIL
			ON BUYGOODS.BUY_GOODS_SID = DETAIL.BUY_GOODS_SID
		WHERE
			BUYGOODS.BUY_GOODS_TYPE = #buyGoodsType# AND BUYGOODS.MBER_ID = #mberId# AND DETAIL.DETAIL_STATUS = #detailStatus#
		ORDER BY
			BUYGOODS.GOODS_CODE ASC
	</select>
	
	<select id="buyDAO.selectBuyDetailList"  parameterClass="buyGoodsVO" resultClass="buyGoodsDetailVO" cacheModel="RFCBuyManageCache">
		SELECT
			DETAIL.BUY_GOODS_SID buyGoodsSid,
			DETAIL.BUY_CODE buyCode,
			DETAIL.GOODS_CODE goodsCode,
            DETAIL.DETAIL_SID detailSid,
			DETAIL.DETAIL_DEFF detailDeff,			
			DETAIL.GOODS_IS_BUNDLE goodsIsBundle,
			DETAIL.GOODS_WEIGHT goodsWeight,
			DETAIL.GOODS_PRICE goodsPrice,
			DETAIL.DELIVERY_TYPE deliveryType,
			DETAIL.DELIVERY_COMPANY deliveryCompany,
			DETAIL.DELIVERY_NUMBER deliveryNumber,
			DETAIL.DELIVERY_DATE deliveryDate,
			DETAIL.DETAIL_STATUS detailStatus,
			DETAIL.DELIVERY_MEMO deliveryMemo,
			DETAIL.GOODS_COUNT goodsCount,
			DETAIL.MNG_ID mngId,
			DETAIL.GOODS_OPTION1 goodsOption1,
			DETAIL.GOODS_OPTION_COUNT1 goodsOptionCount1,
			DETAIL.GOODS_OPTION_TEXT1 goodsOptionText1,
			DETAIL.GOODS_OPTION2 goodsOption2,
			DETAIL.GOODS_OPTION_COUNT2 goodsOptionCount2,
			DETAIL.GOODS_OPTION_TEXT2 goodsOptionText2,
			DETAIL.DETAIL_MODIFY_DATE modify_dt
		FROM
			RFC_COMTNBUYGOODSDETAIL DETAIL
		WHERE
			1=1
			<isNotEqual prepend="AND" property="isManager" compareValue="true">
				( DETAIL.MBER_ID = #mberId# OR DETAIL.MBER_ID = #sessionId# )
			</isNotEqual>			 
			<isNotEmpty prepend="AND" property="buyCode" >
				DETAIL.BUY_CODE = #buyCode#
			</isNotEmpty>
			<isEmpty prepend="AND" property="buyCode" >
				DETAIL.DETAIL_SID IN ( $detailSid$ ) AND (DETAIL.BUY_CODE = '' OR DETAIL.BUY_CODE IS NULL)
			</isEmpty>
		ORDER BY
			DETAIL.GOODS_CODE ASC
	</select>
	<select id="buyDAO.selectBuyGoodsXlsList" parameterClass="goodsVO"  resultClass="goodsVO" cacheModel="RFCBuyManageCache">
			SELECT GOODS_CODE goodsCode, 
			       (SELECT GOODS_TITLE 
			         FROM RFC_COMTNGOODS 
			        WHERE GOODS_CODE = A.GOODS_CODE 
			       ) goodsTitle, 
			       IFNULL((SELECT COUNT(*) 
			         FROM RFC_COMTNBUYGOODSDETAIL B 
			          INNER JOIN RFC_COMTNBUYINFO C 
			              ON B.BUY_CODE = C.BUY_CODE 
			        WHERE GOODS_CODE = A.GOODS_CODE 
			              AND C.BUY_STATUS = 'C' 
			              AND PACKTYPECD IS NULL 
			              AND 
			              ( 
			                  DETAIL_STATUS NOT IN ('D','C','L') 
			              ) 
			       ),0) count1, 
			       IFNULL((SELECT COUNT(*) 
			         FROM RFC_COMTNBUYGOODSDETAIL B 
			          INNER JOIN RFC_COMTNBUYINFO C 
			              ON B.BUY_CODE = C.BUY_CODE 
			        WHERE GOODS_CODE = A.GOODS_CODE 
			              AND C.BUY_STATUS = 'C' 
			              AND PACKTYPECD IS NULL 
			              AND 
			              ( 
			                  DETAIL_STATUS NOT IN ('W','D') 
			              ) 
			       ),0) count2, 
			       IFNULL((SELECT COUNT(*) 
			         FROM RFC_COMTNBUYGOODSDETAIL B 
			          INNER JOIN RFC_COMTNBUYINFO C 
			              ON B.BUY_CODE = C.BUY_CODE 
			        WHERE GOODS_CODE = A.GOODS_CODE 
			              AND C.BUY_STATUS = 'C' 
			              AND PACKTYPECD IS NULL 
			              AND 
			              ( 
			                  DETAIL_STATUS NOT IN ('D','C','L') 
			              ) 
			       )*
			       (SELECT SUM(GOODS_COUNT) 
			         FROM RFC_COMTNBUYGOODSDETAIL B 
			          INNER JOIN RFC_COMTNBUYINFO C 
			              ON B.BUY_CODE = C.BUY_CODE 
			        WHERE GOODS_CODE = A.GOODS_CODE 
			              AND C.BUY_STATUS = 'C' 
			              AND PACKTYPECD IS NULL 
			              AND 
			              ( 
			                  DETAIL_STATUS NOT IN ('D','C','L') 
			              ) 
			       ),0) count3 
			  FROM RFC_COMTNBUYGOODSDETAIL A 
			 WHERE PACKTYPECD IS NULL 
			 GROUP BY GOODS_CODE
	</select>
	<select id="buyDAO.selectBuyXlsList" parameterClass="buyInfoVO"  resultClass="buyInfoVO" cacheModel="RFCBuyManageCache">
		SELECT
		    INFO.BUY_REGISTER_DATE register_dt,
		    INFO.BUY_CODE buyCode,
		    MBER.MBER_NM mberNm,
		    INFO.RECEIVE_NAME receiveName,
		    INFO.RECEIVE_ADDRESS receiveAddress,
		    SCP.DEC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,INFO.RECEIVE_DETAIL_ADDRESS) receiveDetailAddress,
		    INFO.RECEIVE_ZIPCODE receiveZipcode,
		    SCP.DEC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,INFO.RECEIVE_TEL) receiveTel,
		    SCP.DEC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,INFO.RECEIVE_CEL) receiveCel,
		    INFO.BUY_TOTAL_PRICE buyTotalPrice,
		    INFO.BILL_TYPE billType,		    
		    INFO.BILL_PRICE billPrice,
		    GOODS.GOODS_TITLE goodsTitle,
            DETAIL.GOODS_COUNT goodsCount,
            DETAIL.DETAIL_SID detailSid,
            DETAIL.DELIVERY_COMPANY deliveryCompany,
			DETAIL.DELIVERY_NUMBER deliveryNumber,
			DETAIL.GOODS_OPTION1 goodsOption1,
			DETAIL.GOODS_OPTION_COUNT1 goodsOptionCount1,
			DETAIL.GOODS_OPTION_TEXT1 goodsOptionText1,
			DETAIL.GOODS_OPTION2 goodsOption2,
			DETAIL.GOODS_OPTION_COUNT2 goodsOptionCount2,
			DETAIL.GOODS_OPTION_TEXT2 goodsOptionText2,
		    INFO.RECOMMAND_NAME recommandName,
			INFO.RECOMMAND_TEL recommandTel,
			INFO.RECOMMAND_WORK recommandWork,
			INFO.RECOMMAND_PART recommandPart,
			INFO.MANAGER_MEMO managerMemo,
			INFO.DELIVERY_MEMO deliveryMemo,
			DETAIL.DETAIL_STATUS detailStatus,
			DETAIL.DELIVERY_DATE deliveryDate
		FROM
		    RFC_COMTNBUYINFO INFO INNER JOIN RFC_COMTNBUYGOODSDETAIL DETAIL
		    ON INFO.BUY_CODE = DETAIL.BUY_CODE
		    LEFT OUTER JOIN  RFC_COMTNMEMBER MBER
		    ON INFO.MBER_ID = MBER.MBER_ID
		    LEFT OUTER JOIN  RFC_COMTNGOODS GOODS
		    ON DETAIL.GOODS_CODE = GOODS.GOODS_CODE
        WHERE INFO.BUY_STATUS = 'C' AND DETAIL.PACKTYPECD IS NULL AND (DETAIL.DETAIL_STATUS IS NULL OR DETAIL.DETAIL_STATUS NOT IN ('D','C'))
		ORDER BY INFO.FIXED_DATE ASC		
	</select>
	<update id="buyDAO.updateDetailStatus" parameterClass="buyInfoVO">
		UPDATE RFC_COMTNBUYGOODSDETAIL
		SET 
			<isNotEmpty property="deliveryDate" >
				DELIVERY_DATE = #deliveryDate#,
			</isNotEmpty>
			DETAIL_STATUS = #detailStatus#			
		WHERE
			DETAIL_SID IN ($detailSid$)				
	</update>
	
	<select id="buyDAO.selectBuyList"  parameterClass="buyInfoVO" resultClass="buyInfoVO" cacheModel="RFCBuyManageCache">
		SELECT  RNUM, 
				       buyCode, 
				       mberId, 
				       buyStatus, 
				       buyTotalPrice, 
				       billPrice, 
				       billType, 
				       billApproval, 
				       billBank, 
				       billAccount, 
				       billPayName, 
				       multiDelivery, 
				       fixed_dt, 
				       modify_dt, 
				       register_dt, 
				       receiveName, 
				       receiveAddress, 
				       SCP.DEC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,receiveDetailAddress) receiveDetailAddress, 
				       receiveZipcode, 
				       SCP.DEC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,receiveTel) receiveTel,
				       SCP.DEC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,receiveCel) receiveCel,
				       recommandName, 
				       recommandTel, 
				       recommandWork, 
				       recommandPart, 
				       managerMemo, 
				       nonPayment, 
				       deliveryMemo, 
				       mberNm 
			FROM (
				SELECT ROWNUM RNUM, ALL_LIST.*  
				FROM  
				(
					SELECT
					    DISTINCT(INFO.BUY_CODE) buyCode,
					    INFO.MBER_ID mberId,
					    INFO.BUY_STATUS buyStatus,
					    INFO.BUY_TOTAL_PRICE buyTotalPrice,
					    INFO.BILL_PRICE billPrice,
					    INFO.BILL_TYPE billType,
					    INFO.BILL_APPROVAL billApproval,
					    INFO.BILL_BANK billBank,
					    INFO.BILL_ACCOUNT billAccount,
					    INFO.BILL_PAYNAME billPayName,
					    INFO.MULTI_DELIVERY multiDelivery,
					    INFO.FIXED_DATE fixed_dt,
					    INFO.BUY_MODIFY_DATE modify_dt,
					    INFO.BUY_REGISTER_DATE register_dt,
					    INFO.RECEIVE_NAME receiveName,
					    INFO.RECEIVE_ADDRESS receiveAddress,
					    INFO.RECEIVE_DETAIL_ADDRESS receiveDetailAddress,
					    INFO.RECEIVE_ZIPCODE receiveZipcode,
					    INFO.RECEIVE_TEL receiveTel,
					    INFO.RECEIVE_CEL receiveCel,					    
					    INFO.RECOMMAND_NAME recommandName,
						INFO.RECOMMAND_TEL recommandTel,
						INFO.RECOMMAND_WORK recommandWork,
						INFO.RECOMMAND_PART recommandPart,
						INFO.MANAGER_MEMO managerMemo,
						INFO.NON_PAYMENT nonPayment,
						INFO.DELIVERY_MEMO deliveryMemo,
                        MBER.MBER_NM mberNm
					FROM
					    RFC_COMTNBUYINFO INFO INNER JOIN RFC_COMTNBUYGOODSDETAIL DETAIL
					    ON INFO.BUY_CODE = DETAIL.BUY_CODE
					    LEFT OUTER JOIN  RFC_COMTNMEMBER MBER
					    ON INFO.MBER_ID = MBER.MBER_ID
					WHERE
						1=1
						<isNotEmpty prepend="AND" property="searchCondition" >
							<isNotEmpty property="searchKeyword" >
			          		     $searchCondition$  LIKE '%$searchKeyword$%'
		          		    </isNotEmpty>
			            </isNotEmpty>	
						<isEqual prepend="AND" property="isManager" compareValue="true">
							<isNotEmpty property="buyStatus" >
								INFO.BUY_STATUS = #buyStatus#
							</isNotEmpty>
							<isEmpty property="buyStatus" >
								(INFO.BUY_STATUS = 'W' OR INFO.BUY_STATUS = 'S' OR INFO.BUY_STATUS = 'C' OR INFO.BUY_STATUS = 'L')
							</isEmpty>
						</isEqual>
						<isNotEmpty prepend="AND" property="buyCode" >
							INFO.BUY_CODE = #buyCode#
						</isNotEmpty>
						<isNotEmpty prepend="AND" property="billType" >
							INFO.BILL_TYPE = #billType#
						</isNotEmpty>
						<isNotEmpty property="userType" >
							<isEqual prepend="AND" property="userType" compareValue="M">
								INFO.MBER_ID NOT LIKE 'USR_%'
							</isEqual>
							<isEqual prepend="AND" property="userType" compareValue="G">
								INFO.MBER_ID LIKE 'USR_%'
							</isEqual>							
						</isNotEmpty>
						<isNotEmpty prepend="AND" property="goodsCode" >
							DETAIL.GOODS_CODE = #goodsCode#
						</isNotEmpty>
						<isNotEmpty prepend="AND" property="mberId" >
							INFO.MBER_ID = #mberId#
						</isNotEmpty>
						<isNotEmpty prepend="AND" property="start_dt" >
							INFO.BUY_REGISTER_DATE >= #start_dt#
						</isNotEmpty>
						<isNotEmpty prepend="AND" property="end_dt" >
							#end_dt# >= INFO.BUY_REGISTER_DATE 
						</isNotEmpty>
					ORDER BY INFO.BUY_REGISTER_DATE DESC
				) ALL_LIST
			)
		WHERE  
			RNUM  &gt; #firstIndex#
			AND  RNUM &lt;= #firstIndex# + #recordCountPerPage#		
	</select>
	
	<select id="buyDAO.getBuyGuestInfo"  parameterClass="buyInfoVO" resultClass="buyInfoVO" cacheModel="RFCBuyManageCache">
		SELECT
		    BUY_CODE buyCode,
		    MBER_ID mberId,
		    SCP.DEC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,RECEIVE_TEL) receiveTel, 
		    SCP.DEC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,RECEIVE_CEL) receiveCel 
		FROM
		    RFC_COMTNBUYINFO
		WHERE
			BUY_CODE = #buyCode#
			<isNotEmpty property="receiveTel" prepend="AND">
				RECEIVE_TEL = SCP.ENC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,#receiveTel#)
			</isNotEmpty>						  
			<isNotEmpty property="receiveCel" prepend="AND">
				RECEIVE_CEL = SCP.ENC_STR(#damoUser#,'RFC_COMTNBUYINFO',#damoKey#,#receiveCel#)							
			</isNotEmpty>
	</select>
	
	<select id="buyDAO.selectBuyListTotal"  parameterClass="buyInfoVO" resultClass="int" cacheModel="RFCBuyManageCache">		
		SELECT
			count(DISTINCT(INFO.BUY_CODE)) totcnt
		FROM
			RFC_COMTNBUYINFO INFO INNER JOIN RFC_COMTNBUYGOODSDETAIL DETAIL
		    ON INFO.BUY_CODE = DETAIL.BUY_CODE
		WHERE
			1=1
			<isNotEmpty prepend="AND" property="searchCondition" >
				<isNotEmpty property="searchKeyword" >
          		     $searchCondition$  LIKE '%$searchKeyword$%'
         		    </isNotEmpty>
            </isNotEmpty>	
			<isEqual prepend="AND" property="isManager" compareValue="true">
				<isNotEmpty property="buyStatus" >
					INFO.BUY_STATUS = #buyStatus#
				</isNotEmpty>
				<isEmpty property="buyStatus" >
					(INFO.BUY_STATUS = 'W' OR INFO.BUY_STATUS = 'S' OR INFO.BUY_STATUS = 'C' OR INFO.BUY_STATUS = 'L')
				</isEmpty>
			</isEqual>
			<isNotEmpty prepend="AND" property="buyCode" >
				INFO.BUY_CODE = #buyCode#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="billType" >
				INFO.BILL_TYPE = #billType#
			</isNotEmpty>
			<isNotEmpty property="userType" >
				<isEqual prepend="AND" property="userType" compareValue="M">
					INFO.MBER_ID NOT LIKE 'USR_%'
				</isEqual>
				<isEqual prepend="AND" property="userType" compareValue="G">
					INFO.MBER_ID LIKE 'USR_%'
				</isEqual>							
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="goodsCode" >
				DETAIL.GOODS_CODE = #goodsCode#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="mberId" >
				INFO.MBER_ID = #mberId#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="start_dt" >
				INFO.BUY_REGISTER_DATE >= #start_dt#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="end_dt" >
				#end_dt# >= INFO.BUY_REGISTER_DATE 
			</isNotEmpty>				
	</select>
	
	<insert id="buyDAO.insertBuyGoods"  parameterClass="buyGoodsVO">
		INSERT INTO RFC_COMTNBUYGOODS
		(
			BUY_GOODS_SID,
			BUY_CODE,
			GOODS_CODE,
			BUY_GOODS_TYPE,
			MBER_ID,
			BUY_GOODS_MODIFY_DATE
		)
		VALUES
		(
			#buyGoodsSid#,
			#buyCode#,
			#goodsCode#,
			#buyGoodsType#,
			#mberId#,
			#modify_dt#
		)
	</insert>
	<insert id="buyDAO.insertBuyHistory"  parameterClass="buyHistoryVO">
		INSERT INTO RFC_COMTNBUYHISTORY
		(
			BUY_CODE,
			BUY_ACTION,
			ACTION_IP,
			ACTION_MESSAGE,
			ACTION_DATE
		)
		VALUES
		(
			#buyCode#,
			#buyAction#,
			#actionIp#,
			#actionMessage#,
			#action_dt#
		)		
	</insert>
	<insert id="buyDAO.insertBuyGoodsDetail"  parameterClass="buyGoodsDetailVO">
		INSERT INTO RFC_COMTNBUYGOODSDETAIL
		(
			DETAIL_SID,
			BUY_GOODS_SID,
			BUY_CODE,
			GOODS_CODE,
			packTypeCd,
			DETAIL_DEFF,
			MBER_ID,			
			GOODS_IS_BUNDLE,
			GOODS_WEIGHT,
			GOODS_PRICE,			
			DELIVERY_TYPE,
			DELIVERY_COMPANY,
			DELIVERY_NUMBER,
			DELIVERY_DATE,
			DETAIL_STATUS,
			DELIVERY_MEMO,
			GOODS_COUNT,
			MNG_ID,
			GOODS_OPTION1,
			GOODS_OPTION_COUNT1,
			GOODS_OPTION_TEXT1,
			GOODS_OPTION2,
			GOODS_OPTION_COUNT2,
			GOODS_OPTION_TEXT2,
			DETAIL_MODIFY_DATE
		)
		VALUES
		(
			#detailSid#,
			#buyGoodsSid#,
			#buyCode#,
			#goodsCode#,
			#packTypeCd#,
			#detailDeff#,
			#mberId#,			
			#goodsIsBundle#,
			#goodsWeight#,
			#goodsPrice#,
			#deliveryType#,
			#deliveryCompany#,
			#deliveryNumber#,
			#deliveryDate#,
			#detailStatus#,
			#deliveryMemo#,
			#goodsCount#,
			#mngId#,
			#goodsOption1#,
			#goodsOptionCount1#,
			#goodsOptionText1#,
			#goodsOption2#,
			#goodsOptionCount2#,
			#goodsOptionText2#,
			#modify_dt#
		)
	</insert>
	
	<select id="buyDAO.getBuyDetail"  parameterClass="buyGoodsDetailVO" resultClass="buyGoodsDetailVO" cacheModel="RFCBuyManageCache">		
		SELECT
			DETAIL_SID	detailSid,
			BUY_GOODS_SID	buyGoodsSid,
			BUY_CODE	buyCode,
			GOODS_CODE	goodsCode,
			packTypeCd packTypeCd,
			DETAIL_DEFF	detailDeff,
			MBER_ID	mberId,
			GOODS_IS_BUNDLE	goodsIsBundle,
			GOODS_WEIGHT	goodsWeight,
			GOODS_PRICE	goodsPrice,
			DELIVERY_TYPE	deliveryType,
			DELIVERY_COMPANY	deliveryCompany,
			DELIVERY_NUMBER	deliveryNumber,
			DELIVERY_DATE	deliveryDate,
			DETAIL_STATUS	detailStatus,
			DELIVERY_MEMO	deliveryMemo,
			GOODS_COUNT	goodsCount,
			MNG_ID	mngId,
			GOODS_OPTION1	goodsOption1,
			GOODS_OPTION_COUNT1 goodsOptionCount1,
			GOODS_OPTION_TEXT1 goodsOptionText1,
			GOODS_OPTION2	goodsOption2,
			GOODS_OPTION_COUNT2 goodsOptionCount2,
			GOODS_OPTION_TEXT2 goodsOptionText2,
			DETAIL_MODIFY_DATE	modify_dt
		FROM
			RFC_COMTNBUYGOODSDETAIL
		WHERE
			<isNotEqual property="detailSid" compareValue="0">
				DETAIL_SID = #detailSid#
			</isNotEqual>		
		ORDER BY DETAIL_SID ASC
	</select>
	
	<update id="buyDAO.updateBuyGoodsDetail"  parameterClass="buyGoodsDetailVO">
		UPDATE RFC_COMTNBUYGOODSDETAIL
		SET		
			MBER_ID = #mberId#,
			BUY_CODE = #buyCode#,			
			DETAIL_STATUS = #detailStatus#,
			DELIVERY_MEMO = #deliveryMemo#,
			DETAIL_MODIFY_DATE = #modify_dt#
		WHERE
			DETAIL_SID = #detailSid#
	</update>
		
	<delete id="buyDAO.deleteBuyGoodsDetail"  parameterClass="buyGoodsDetailVO">
		DELETE
		FROM		
			RFC_COMTNBUYGOODSDETAIL			
		WHERE
			DETAIL_SID = #detailSid# AND (BUY_CODE IS NULL OR REPLACE(BUY_CODE,' ','') IS NULL) AND MBER_ID = #mberId# 
	</delete>
	
	<select id="buyDAO.getMallUserInfo"  parameterClass="java.util.HashMap"  resultClass="MberManageVO"  cacheModel="RFCBuyManageCache">
				select 
						UNIQ_ID uniqId ,
						MBER_ID mberId,
						MBER_NM mberNm,
						ZIP zip,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,ADRES) adres,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,DETAIL_ADRES) detailAdres,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,AREA_NO) areaNo,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,MIDDLETEL_NO) middleTelno,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,ENDTEL_NO) endTelno,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,MOBLFRIST_NO) moblfristNo,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,MOBLMIDDLE_NO) moblmiddleNo,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,MOBLEND_NO) moblendNo,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,EMAIL_ADRES) emailAdres				
					from 
						RFC_COMTNMEMBER
					where
						MBER_ID = #mberId#
	</select>
	
	<select id="buyDAO.getMallGuestUserInfo"  parameterClass="buyInfoVO"  resultClass="MberManageVO"  cacheModel="RFCBuyManageCache">
				select 
						UNIQ_ID uniqId ,
						MBER_ID mberId,
						MBER_NM mberNm,
						ZIP zip,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,ADRES) adres,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,DETAIL_ADRES) detailAdres,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,AREA_NO) areaNo,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,MIDDLETEL_NO) middleTelno,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,ENDTEL_NO) endTelno,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,MOBLFRIST_NO) moblfristNo,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,MOBLMIDDLE_NO) moblmiddleNo,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,MOBLEND_NO) moblendNo,
						SCP.DEC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,EMAIL_ADRES) emailAdres				
					from 
						RFC_COMTNMEMBER
					where
						MBER_NM = #name#
						AND
							CONCAT(CONCAT(CONCAT(CONCAT(AREA_NO,'-'),MIDDLETEL_NO),'-'),ENDTEL_NO) = #tel#
						AND
							CONCAT(CONCAT(CONCAT(CONCAT(MOBLFRIST_NO,'-'),MOBLMIDDLE_NO),'-'),MOBLEND_NO) = #cel#
	</select>
	
	<update id="buyDAO.updateMallUserInfo"  parameterClass="MberManageVO" >
		UPDATE RFC_COMTNMEMBER
		SET
			ZIP = #zip#,
			ADRES = SCP.ENC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,#adres#),
			DETAIL_ADRES = SCP.ENC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,#detailAdres#),
			AREA_NO = SCP.ENC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,#areaNo#),
			MIDDLETEL_NO = SCP.ENC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,#middleTelno#),
			ENDTEL_NO = SCP.ENC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,#endTelno#),
			MOBLFRIST_NO = SCP.ENC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,#moblfristNo#),
			MOBLMIDDLE_NO = SCP.ENC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,#moblmiddleNo#),
			MOBLEND_NO = SCP.ENC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,#moblendNo#),
			EMAIL_ADRES = SCP.ENC_STR(#damoUser#,'RFC_COMTNMEMBER',#damoKey#,#emailAdres#) 
		WHERE
			MBER_ID = #mberId#
	</update>
	
	<select id="buyDAO.isGoodsBuyUser" parameterClass="buyInfoVO" resultClass="int" cacheModel="RFCBuyManageCache">
		SELECT
			count(*) totcnt
		FROM
			RFC_COMTNBUYINFO INFO INNER JOIN RFC_COMTNBUYGOODSDETAIL DETAIL
			ON INFO.BUY_CODE = DETAIL.BUY_CODE
		WHERE
			DETAIL.GOODS_CODE = #goodsCode# AND INFO.MBER_ID = #mberId# AND ( INFO.BUY_STATUS = 'C' OR INFO.BUY_STATUS = 'L' OR INFO.BUY_STATUS = 'E' )
	</select>
		
</sqlMap>