<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="RFCPopupManage">
	<typeAlias  alias="egovMap"      type = "egovframework.rte.psl.dataaccess.util.EgovMap"/>
    <typeAlias  alias="popupVO"	 type = "egovframework.rfc3.popup.vo.PopupVO"/>
    <typeAlias  alias="popupUseDomainVO"	 type = "egovframework.rfc3.popup.vo.PopupUseDomainVO"/>
    
    <cacheModel type="${Globals.ibatis.default.cache}" id="RFCPopupManageCache" readOnly="true" serialize="false">
      	<flushInterval hours="24" />
      	<flushOnExecute statement="popupDAO.insertPopup"/>
      	<flushOnExecute statement="popupDAO.updatePopup"/>
      	<flushOnExecute statement="popupDAO.deletePopup"/>
     </cacheModel>
    <select id="popupDAO.selectPopupListTotal"  parameterClass="popupVO" resultClass="int" cacheModel="RFCPopupManageCache">
    	SELECT
    		count(*) totcnt
    	FROM
    		RFC_COMTNPOPUP
    	WHERE
    		1=1 AND POPUP_MODE = #popupMode#
    		<isNotEmpty prepend="AND" property="searchCondition" >
          		     $searchCondition$  LIKE '%$searchKeyword$%'
            </isNotEmpty>		
           <isNotEmpty prepend="AND" property="sgroupId" >
          		     SGROUP_ID  = #sgroupId#
            </isNotEmpty>
            <isNotEmpty prepend="AND" property="domainId" >
                    DOMAIN_ID  = #domainId#
             </isNotEmpty> 
             <isEmpty  property="domainId" >
                	<isEqual  prepend="AND"   property="isDomainAdmin" compareValue="true">
                  	   DOMAIN_ID in ( $myDomainList$ )
       			</isEqual>
            </isEmpty>
             <isNotEmpty prepend="AND" property="popupCategoryCode" >
          		       POPUP_CATEGORY_CODE  = #popupCategoryCode#
            </isNotEmpty>
  	</select>
  	<select id="popupDAO.selectPopupList"  parameterClass="popupVO" resultClass="popupVO" cacheModel="RFCPopupManageCache">
    	SELECT
    		POPUP_SID popupSid,
			SGROUP_ID sgroupId,
			DOMAIN_ID domainId,
			POPUP_CATEGORY_CODE popupCategoryCode,
			(select POPUP_CATEGORY_TITLE from RFC_COMTNPOPUPCATE where POPUP_CATEGORY_CODE=A.POPUP_CATEGORY_CODE limit 1) popupCategoryTitle,
			POPUP_TITLE popupTitle,
			POPUP_MODE popupMode,
			START_DATE startDate,
			END_DATE endDate,
			POPUP_WIDTH popupWidth,
			POPUP_HEIGHT popupHeight,
			POPUP_LEFT popupLeft,
			POPUP_TOP popupTop,
			POPUP_SCROLL popupScroll,
			POPUP_TYPE popupType,
			POPUP_FILE popupFile,
			POPUP_URL popupUrl,
			POPUP_TARGET popupTarget,
			POPUP_CONTENT popupContent,
			POPUP_SUMMARY popupSummary,
			POPUP_ISUSE popupIsUse,
			POPUP_ISGROUP popupIsGroup,
			POPUP_ORDERIDX popupOrderIdx,
			REGISTER_DATE register_dt
    	FROM
    		RFC_COMTNPOPUP A
    	WHERE
    		1=1 AND POPUP_MODE = #popupMode#
    		<isNotEmpty prepend="AND" property="searchCondition" >
          		     $searchCondition$  LIKE '%$searchKeyword$%'
            </isNotEmpty>		
           <isNotEmpty prepend="AND" property="sgroupId" >
          		     SGROUP_ID  = #sgroupId#
            </isNotEmpty>
            <isNotEmpty prepend="AND" property="domainId" >
                    DOMAIN_ID  = #domainId#
             </isNotEmpty> 
             <isEmpty  property="domainId" >
                	<isEqual  prepend="AND"   property="isDomainAdmin" compareValue="true">
                  	   DOMAIN_ID in ( $myDomainList$ )
       			</isEqual>
            </isEmpty>
            <isNotEmpty prepend="AND" property="popupCategoryCode" >
          		       POPUP_CATEGORY_CODE  = #popupCategoryCode#
            </isNotEmpty>
            
            <isEqual  property="orderByStepBy"  compareValue="true" >
		       ORDER BY  CASE
	                  WHEN START_DATE IS NULL AND END_DATE IS NULL  THEN 0 
	                  WHEN START_DATE IS NOT  NULL AND END_DATE IS  NULL  THEN 1
	                  WHEN START_DATE IS NULL AND END_DATE IS NOT   NULL  THEN 2
	                  WHEN START_DATE IS NOT   NULL AND END_DATE IS NOT   NULL  THEN 3
	                  ELSE 99
	                  END ASC,
	                  START_DATE DESC, END_DATE DESC,
	                  POPUP_ISUSE DESC, POPUP_CATEGORY_CODE ASC, POPUP_ORDERIDX ASC
	       	</isEqual>
	       	<isEqual  property="orderByStepBy"  compareValue="false" >
	       		ORDER BY REGISTER_DATE DESC
	       	</isEqual>
  
   		LIMIT #recordCountPerPage# OFFSET #firstIndex#
  	</select>
  	
  	<select id="popupDAO.getPopup"  parameterClass="popupVO" resultClass="popupVO" cacheModel="RFCPopupManageCache">
    	SELECT
    		POPUP_SID popupSid,
			SGROUP_ID sgroupId,
			DOMAIN_ID domainId,
			POPUP_CATEGORY_CODE popupCategoryCode,
			POPUP_TITLE popupTitle,
			POPUP_MODE popupMode,
			START_DATE startDate,
			END_DATE endDate,
			POPUP_WIDTH popupWidth,
			POPUP_HEIGHT popupHeight,
			POPUP_LEFT popupLeft,
			POPUP_TOP popupTop,
			POPUP_SCROLL popupScroll,
			POPUP_TYPE popupType,
			POPUP_FILE popupFile,
			POPUP_URL popupUrl,
			POPUP_TARGET popupTarget,
			POPUP_CONTENT popupContent,
			POPUP_SUMMARY popupSummary,
			POPUP_ISUSE popupIsUse,
			POPUP_ISGROUP popupIsGroup,
			POPUP_ORDERIDX popupOrderIdx,
			REGISTER_DATE register_dt
    	FROM
    		RFC_COMTNPOPUP
    	WHERE
			POPUP_SID = #popupSid# 
    </select>
  	
  	<insert id="popupDAO.insertPopup"  parameterClass="popupVO" >
    	INSERT INTO RFC_COMTNPOPUP
    	(
    		POPUP_SID,
			SGROUP_ID,
			DOMAIN_ID,
			POPUP_CATEGORY_CODE,
			POPUP_TITLE,
			POPUP_MODE,
			START_DATE,
			END_DATE,
			POPUP_WIDTH,
			POPUP_HEIGHT,
			POPUP_LEFT,
			POPUP_TOP,
			POPUP_SCROLL,
			POPUP_TYPE,
			POPUP_FILE,
			POPUP_URL,
			POPUP_TARGET,
			POPUP_CONTENT,
			POPUP_SUMMARY,
			POPUP_ISUSE,
			POPUP_ISGROUP,
			POPUP_ORDERIDX,
			REGISTER_DATE
		)
		VALUES
		(
			#popupSid#,
			#sgroupId#,
			#domainId#,
			#popupCategoryCode#,
			#popupTitle#,
			#popupMode#,
			#startDate#,
			#endDate#,
			#popupWidth#,
			#popupHeight#,
			#popupLeft#,
			#popupTop#,
			#popupScroll#,
			#popupType#,
			#popupFile#,
			#popupUrl#,
			#popupTarget#,
			#popupContent#,
			#popupSummary#,
			#popupIsUse#,
			#popupIsGroup#,
			#popupOrderIdx#,
			#register_dt#
		)    	
  	</insert>
  	
  	<update id="popupDAO.updatePopup"  parameterClass="popupVO" >
    	UPDATE RFC_COMTNPOPUP
    	SET
			SGROUP_ID=#sgroupId#,
			DOMAIN_ID=#domainId#,
			POPUP_CATEGORY_CODE=#popupCategoryCode#,
			POPUP_TITLE=#popupTitle#,
			START_DATE=#startDate#,
			END_DATE=#endDate#,
			POPUP_WIDTH=#popupWidth#,
			POPUP_HEIGHT=#popupHeight#,
			POPUP_LEFT=#popupLeft#,
			POPUP_TOP=#popupTop#,
			POPUP_SCROLL=#popupScroll#,
			POPUP_TYPE=#popupType#,
			<isNotEmpty property="popupFile" >
            	POPUP_FILE=#popupFile#,
            </isNotEmpty>
			POPUP_URL=#popupUrl#,
			POPUP_TARGET=#popupTarget#,
			POPUP_CONTENT=#popupContent#,
			POPUP_SUMMARY=#popupSummary#,
			POPUP_ISUSE=#popupIsUse#,
			POPUP_ISGROUP=#popupIsGroup#,
			POPUP_ORDERIDX=#popupOrderIdx#
		WHERE
			POPUP_SID = #popupSid# 
  	</update>
  	
  	<delete id="popupDAO.deletePopup"  parameterClass="popupVO" >
    	DELETE FROM RFC_COMTNPOPUP
    	WHERE
			POPUP_SID = #popupSid# 
  	</delete>
  	
  	<select id="popupDAO.userSelectPopupList"  parameterClass="popupVO" resultClass="popupVO" cacheModel="RFCPopupManageCache">
    	SELECT
    		POPUP_SID popupSid,
			SGROUP_ID sgroupId,
			DOMAIN_ID domainId,
			POPUP_CATEGORY_CODE popupCategoryCode,
			(select POPUP_CATEGORY_TITLE from RFC_COMTNPOPUPCATE where POPUP_CATEGORY_CODE=A.POPUP_CATEGORY_CODE limit 1) popupCategoryTitle,
			POPUP_TITLE popupTitle,
			POPUP_MODE popupMode,
			START_DATE startDate,
			END_DATE endDate,
			POPUP_WIDTH popupWidth,
			POPUP_HEIGHT popupHeight,
			POPUP_LEFT popupLeft,
			POPUP_TOP popupTop,
			POPUP_SCROLL popupScroll,
			POPUP_TYPE popupType,
			POPUP_FILE popupFile,
			POPUP_URL popupUrl,
			POPUP_TARGET popupTarget,
			POPUP_CONTENT popupContent,
			POPUP_SUMMARY popupSummary,
			POPUP_ISUSE popupIsUse,
			POPUP_ISGROUP popupIsGroup,
			POPUP_ORDERIDX popupOrderIdx,
			REGISTER_DATE register_dt
    	FROM
    		RFC_COMTNPOPUP A
    	WHERE
			<isNotEmpty property="domainId"><!-- 통합팝업출력으로 isNotEmpty property 추가  기존 DOMAIN_ID = #domainId# AND -->
						DOMAIN_ID = #domainId# AND 
		   </isNotEmpty>
		   POPUP_MODE=#popupMode# AND POPUP_ISGROUP=#popupIsGroup# AND POPUP_ISUSE = 'Y'
			AND ( (START_DATE = '' AND  END_DATE = '')  OR ( #startDate# >= START_DATE AND  END_DATE = '') OR ( START_DATE = '' AND  END_DATE >= #endDate#) OR ( #startDate# >= START_DATE AND END_DATE >= #endDate#) )
			<isNotEmpty prepend="AND" property="popupCategoryCode" >
                    POPUP_CATEGORY_CODE  = #popupCategoryCode#
            </isNotEmpty>
            <isEqual prepend="AND" property="useDomainCheck" compareValue="true">
		                    POPUP_SID in (select  POPUP_SID from RFC_COMTNPOPUP_DOMAIN B where B.POPUP_SID=A.POPUP_SID and B.DOMAIN_ID=#useDomainId# )
		     </isEqual>
        ORDER BY POPUP_ORDERIDX ASC, REGISTER_DATE DESC
		LIMIT #recordCountPerPage# OFFSET 0 
    </select>
    
    
    
    
    
    
    
     <select id="popupDAO.selectUseDomainList"  parameterClass="popupUseDomainVO" resultClass="popupUseDomainVO">
		   SELECT 
		       A.POP_USE_SID popUseSid,
		       A.POPUP_SID popupSid,
		       A.DOMAIN_ID domainId,
		       (select DOMAIN_NM from RFC_COMTNDOMAIN where DOMAIN_ID=A.DOMAIN_ID) domainNm
		  FROM 
		     RFC_COMTNPOPUP_DOMAIN A
		  where 
		     A.POPUP_SID= #popupSid#
		   order by POP_USE_SID desc

    </select>
    
    <select id="popupDAO.isUsePopDomain"  parameterClass="popupUseDomainVO" resultClass="int">
		  SELECT 
		       count(*) as cnt
		  FROM 
		     RFC_COMTNPOPUP_DOMAIN A
		  where 
		     A.POPUP_SID= #popupSid# and A.DOMAIN_ID=#domainId#
    </select>
    
    <insert id="popupDAO.insertUseDomain"  parameterClass="popupUseDomainVO" >
		   INSERT INTO RFC_COMTNPOPUP_DOMAIN (
		       POP_USE_SID,
		       POPUP_SID,
		       DOMAIN_ID ) VALUES (
		       #popUseSid# ,
		       #popupSid# , 
		       #domainId# )
    </insert>
    
    
    <delete id="popupDAO.deleteUsePopDomain"  parameterClass="popupUseDomainVO" >
			  DELETE FROM RFC_COMTNPOPUP_DOMAIN
			  WHERE POP_USE_SID=#popUseSid#
    </delete>
    
  </sqlMap>